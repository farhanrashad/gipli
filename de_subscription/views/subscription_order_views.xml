<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Circulation Agreement Form View -->
    <record id="subscription_order_form_view" model="ir.ui.view">
        <field name="name">subscription.form.view</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_order_form"/>
        <field name="arch" type="xml">
            <xpath expr="//header" position="inside">
                <field name="subscription_order" invisible="1"/>
                <field name="subscription_status" invisible="1"/>
            </xpath>

            <button name="action_cancel" position="after">
                <button string="New Subscription" name="button_new_subscription" type="object"
                        invisible="not subscription_order or subscription_status not in ['progress'] or state != 'sale'" data-hotkey="z"/>
            </button>
            <xpath expr="//div[@name='button_box']" position="after">
                <field name="subscription_status" class="float-end fs-6"
                       invisible="subscription_status not in ['progress', 'close'] or state == 'cancel'"
                       widget="badge"
                       decoration-info="subscription_status in ['draft']"
                       decoration-success="subscription_status in ['progress']"
                       decoration-danger="subscription_status in ['close']"/>
            </xpath>

            <xpath expr="//group[1]/group[2]" position="inside">
                <label name="subscription_plan" for="subscription_plan_id" invisible="not subscription_order"/>
                <div name="subscription_plan" class="o_row" invisible="not subscription_order">
                    <field name="subscription_plan_id" 
                        required="subscription_order == True"
                           readonly="subscription_status in ['progress', ',close']"
                           options="{'no_create': True}"/>
                    <span invisible="not subscription_order ">until</span>
                    <field name="date_end" invisible="not subscription_order"/>
                </div>
            </xpath>

            <!-- Add Subscription fields -->
            <xpath expr="//notebook/page[@name='other_information']/group[1]" position="inside">
                <group string="Subsription" invisible="not subscription_order">
                    <field name="date_last_invoice" />
                    <field name="date_next_invoice" />
                    <field name="date_first_contract" />
                    <field name="date_start" />
                    <field name="date_end" />
                </group>
            </xpath>
                
        </field>
      </record>

    <record id="subscription_order_primary_form_view" model="ir.ui.view">
        <field name="name">subscription.order.primary.form.view</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="subscription_order_form_view"/>
        <field name="mode">primary</field>
        <field name="priority">999</field>
        <field name="arch" type="xml">
            
            <!-- options key for library app knowledge in the configurator -->
            <xpath expr="//notebook/page[@name='order_lines']/field/tree/field[@name='product_id']" position='attributes'>
                <attribute name="context">{
                    'partner_id': parent.partner_id,
                    'quantity': product_uom_qty,
                    'pricelist': parent.pricelist_id,
                    'uom':product_uom,
                    'company_id': parent.company_id,
                    'default_lst_price': price_unit,
                    'default_description_sale': name,
                    'is_recurring': True,
                }
                </attribute>
                <attribute name="domain">
                    [('is_recurring', '=', True),
                        '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]
                </attribute>
                <attribute name="options">{
                    'no_open': True,
                }</attribute>
            </xpath>
            <xpath expr="//notebook/page[@name='order_lines']/field/tree/field[@name='product_template_id']" position='attributes'>
                <attribute name="context">{
                    'partner_id': parent.partner_id,
                    'quantity': product_uom_qty,
                    'pricelist': parent.pricelist_id,
                    'uom':product_uom,
                    'company_id': parent.company_id,
                    'default_list_price': price_unit,
                    'default_description_sale': name,
                    'is_recurring': True,
                }
                </attribute>
                <attribute name="domain">
                    [('is_recurring', '=', True),
                        '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]
                </attribute>
                <attribute name="options">{
                    'no_open': True,
                }</attribute>
            </xpath>
            <xpath expr="//field[@name='order_line']//form//field[@name='product_id']" position='attributes'>
                <attribute name="domain">
                    [('is_recurring', '=', True),
                        '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]
                </attribute>
            </xpath>
        </field>
    </record>
    
    <record id="subscription_order_tree_view" model="ir.ui.view">
      <field name="name">subscription.tree.view</field>
      <field name="model">sale.order</field>
      <field name="arch" type="xml">
        <tree sample="1" >
          <field name="name" readonly="1" decoration-bf="1"/>
          <field name="date_order" widget='date'/>
          <field name="partner_id" readonly="1"/>
          <field name="user_id" optional="show" widget='many2one_avatar_user'/>
          <field name="team_id" optional="hide"/>
          <field name="amount_total" sum="Total Tax Included" widget="monetary" decoration-bf="1"/>
          <field name="state" invisible="1"/>
          <field name="currency_id" invisible="1"/>
        </tree>
      </field>
    </record>

    <!-- Kanban view -->
    <record id="subscription_order_kanban_view" model="ir.ui.view">
        <field name="name">circulation.agreement.kanban.view</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sale_order_kanban"/>
        <field name="mode">primary</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="attributes">
                <attribute name="quick_create">false</attribute>
                <attribute name="class">o_kanban_mobile align-content-start</attribute>
            </xpath>
            <xpath expr="//kanban" position="attributes">
                <attribute name="quick_create">false</attribute>
                <attribute name="class">o_kanban_mobile align-content-start</attribute>
            </xpath>
            
            <xpath expr="//div[hasclass('oe_kanban_bottom_right')]/field[@name='state']" position="attributes">
                <attribute name="invisible">state == 'sale' and subscription_status</attribute>
            </xpath>
            
            <xpath expr="//div[hasclass('oe_kanban_bottom_right')]/field[@name='state']" position="after">
                <field name="subscription_status" widget="label_selection"
                    invisible="state != 'sale' or subscription_status == False"
                    options="{'classes': {'draft': 'default', 'progress': 'warning', 'close': 'success'}}"/>
            </xpath>
        </field>
    </record>
    <!-- Search view -->
    <record id="subscription_order_search_view" model="ir.ui.view">
        <field name="name">circulation.agreement.search.view</field>
        <field name="model">sale.order</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <search>
                <field name="name" string="Order" filter_domain="['|', '|', ('name', 'ilike', self), ('client_order_ref', 'ilike', self), ('partner_id', 'child_of', self)]"/>
                <field name="partner_id" operator="child_of"/>
                <field name="user_id"/>
                <field name="order_line" string="Product" filter_domain="[('order_line.product_id', 'ilike', self)]"/>
                <field name="analytic_account_id" groups="analytic.group_analytic_accounting"/>
                <filter string="My Orders" domain="[('user_id','=',uid)]" name="my_subscription_orders"/>
                <separator/>
                <filter string="Circulation Agreement" domain="[('subscription_order', '=', True)]" name="from_circulation_agreement"/>
                <separator/>
                    
                <filter string="In Progress" domain="[('subscription_order', 'in', ['progress'])]" name="progress_order"/>
                <filter string="Closed" domain="[('subscription_order', 'in', ['close'])]" name="closed_order"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Status" name="groupby_status" context="{'group_by': 'subscription_status'}"/>
                    <separator/>
                    <filter string="Library Officer" name="user_id" domain="[]" context="{'group_by': 'user_id'}"/>
                    <separator/>
                    <filter string="Customer" name="groupby_customer" domain="[]" context="{'group_by': 'partner_id'}"/>
                </group>
                <searchpanel>
                    <field name="subscription_status" icon="fa-retweet" enable_counters="1"/>
                    <field name="invoice_status" icon="fa-retweet" enable_counters="1"/>
                </searchpanel>
            </search>
        </field>
    </record>
    
    <record id="action_subscription_order" model="ir.actions.act_window">
        <field name="name">subscription</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="subscription_order_search_view"/>
        <field name="domain">[('subscription_order', '=', True)]</field>
        <field name="context">{'default_subscription_order': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new request, the first step of a new subscription!
            </p><p>
                Once the request is confirmed, it becomes a subscription.
You will be able to issue and return books to patron.
            </p>
        </field>
    </record>


    <record id="subscription_order_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="subscription_order_kanban_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    <record id="subscription_order_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="subscription_order_tree_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    <record id="subscription_order_primary_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="subscription_order_primary_form_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    
    <menuitem 
        id="menu_subscription_main_subscription" 
        name="Subscriptions" 
        parent="menu_subscription_main" 
        sequence="1" 
        action="action_subscription_order"
    />

    
</odoo>