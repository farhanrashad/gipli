<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <!-- Circulation Agreement Form View -->
    <record id="subscription_order_form_view" model="ir.ui.view">
        <field name="name">subscription.form.view</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="de_subscription.sale_order_form_view_inherit_subscription"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@name='button_box']" position="after">
                <field name="subscription_status" class="float-end fs-6"
                       invisible="subscription_status not in ['progress', 'close'] or state == 'cancel'"
                       widget="badge"
                       decoration-info="subscription_status in ['draft']"
                       decoration-success="subscription_status in ['progress']"
                       decoration-danger="subscription_status in ['close']"/>
            </xpath>
        </field>
      </record>
    
    <record id="subscription_order_tree_view" model="ir.ui.view">
      <field name="name">subscription.tree.view</field>
      <field name="model">sale.order</field>
      <field name="arch" type="xml">
        <tree sample="1" >
          <field name="name" readonly="1" decoration-bf="1"/>
          <field name="date_order" widget='date'/>
          <field name="partner_id" readonly="1"/>
          <field name="user_id" optional="show" widget='many2one_avatar_user'/>
          <field name="team_id" optional="hide"/>
          <field name="amount_total" sum="Total Tax Included" widget="monetary" decoration-bf="1"/>
          <field name="state" invisible="1"/>
          <field name="currency_id" invisible="1"/>
        </tree>
      </field>
    </record>

    <!-- Kanban view -->
    <record id="subscription_order_kanban_view" model="ir.ui.view">
        <field name="name">circulation.agreement.kanban.view</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_sale_order_kanban"/>
        <field name="mode">primary</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <xpath expr="//kanban" position="attributes">
                <attribute name="quick_create">false</attribute>
                <attribute name="class">o_kanban_mobile align-content-start</attribute>
            </xpath>
            <xpath expr="//kanban" position="attributes">
                <attribute name="quick_create">false</attribute>
                <attribute name="class">o_kanban_mobile align-content-start</attribute>
            </xpath>
            <field name="state" position="after">
                <field name="borrow_next_action_date"/>
            </field>
            <xpath expr="//div[hasclass('oe_kanban_bottom_right')]/field[@name='state']" position="attributes">
                <attribute name="invisible">state == 'sale' and borrow_status</attribute>
            </xpath>
            
            <xpath expr="//div[hasclass('oe_kanban_bottom_right')]/field[@name='state']" position="after">
                <field name="borrow_status" widget="label_selection"
                    invisible="state != 'sale' or borrow_status == False"
                    options="{'classes': {'issue': 'info', 'return': 'warning', 'returned': 'success'}}"/>
            </xpath>
        </field>
    </record>
    <!-- Search view -->
    <record id="subscription_order_search_view" model="ir.ui.view">
        <field name="name">circulation.agreement.search.view</field>
        <field name="model">sale.order</field>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <search>
                <field name="name" string="Order" filter_domain="['|', '|', ('name', 'ilike', self), ('client_order_ref', 'ilike', self), ('partner_id', 'child_of', self)]"/>
                <field name="partner_id" operator="child_of"/>
                <field name="user_id"/>
                <field name="order_line" string="Product" filter_domain="[('order_line.product_id', 'ilike', self)]"/>
                <field name="analytic_account_id" groups="analytic.group_analytic_accounting"/>
                <filter string="My Orders" domain="[('user_id','=',uid)]" name="my_borrow_orders"/>
                <separator/>
                <filter string="Circulation Agreement" domain="[('is_borrow_order', '=', True)]" name="from_circulation_agreement"/>
                <separator/>
                    <filter name="filter_today" string="To Do Today"
                    domain="[('borrow_next_action_date','&gt;=', datetime.datetime.combine(context_today(), datetime.time(0,0,0))),
                            ('borrow_next_action_date','&lt;=', datetime.datetime.combine(context_today(), datetime.time(23,59,59)))]"/>
                    <filter string="Late" name="late_circulation_agreements"
                    domain="[('borrow_status', 'in', ['issue', 'return']), ('borrow_next_action_date', '&lt;', (datetime.datetime.now() + relativedelta(hours=1)).strftime('%Y-%m-%d %H:%M:%S'))]"/>
                <separator/>
                <filter string="Reserved" domain="[('borrow_status', 'in', ['reserve'])]" name="reserve_agreement"/>
                <filter string="Issued" domain="[('borrow_status', 'in', ['issue'])]" name="filter_to_issue"/>
                <filter string="Returned" domain="[('borrow_status', 'in', ['return'])]" name="filter_to_return"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Status" name="groupby_status" context="{'group_by': 'borrow_status'}"/>
                    <separator/>
                    <filter string="Library Officer" name="user_id" domain="[]" context="{'group_by': 'user_id'}"/>
                    <separator/>
                    <filter string="Customer" name="groupby_customer" domain="[]" context="{'group_by': 'partner_id'}"/>
                </group>
                <searchpanel>
                    <field name="borrow_status" icon="fa-retweet" enable_counters="1"/>
                    <field name="invoice_status" icon="fa-retweet" enable_counters="1"/>
                </searchpanel>
            </search>
        </field>
    </record>
    
    <record id="action_subscription_order" model="ir.actions.act_window">
        <field name="name">subscription</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="subscription_order_search_view"/>
        <field name="domain">[('subscription_order', '=', True)]</field>
        <field name="context">{'default_subscription_order': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new request, the first step of a new subscription!
            </p><p>
                Once the request is confirmed, it becomes a subscription.
You will be able to issue and return books to patron.
            </p>
        </field>
    </record>


    <record id="subscription_order_kanban" model="ir.actions.act_window.view">
        <field name="sequence" eval="1"/>
        <field name="view_mode">kanban</field>
        <field name="view_id" ref="subscription_order_kanban_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    <record id="subscription_order_tree" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="subscription_order_tree_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    <record id="subscription_order_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="subscription_order_form_view"/>
        <field name="act_window_id" ref="action_subscription_order"/>
    </record>
    
    <menuitem 
        id="menu_subscription_main_subscription" 
        name="Subscriptions" 
        parent="menu_subscription_main" 
        sequence="1" 
        action="action_subscription_order"
    />

    
</odoo>