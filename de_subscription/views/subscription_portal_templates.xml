<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add Breadcrumb -->
    <!-- Modify portal templates -->
    <template id="portal_my_home_menu_sale_subscription" name="Portal layout : subscription menu entry" inherit_id="sale.portal_my_home_menu_sale" priority="10">
         <li id="portal_breadcrumbs_sale" position="after">
             <li t-elif="page_name == 'subscription' or sale_order and sale_order.subscription_order" t-attf-class="breadcrumb-item #{'active ' if not sale_order else ''}">
                <a t-if="sale_order" t-attf-href="/my/suborders?{{ keep_query() }}">Subscriptions</a>
                <t t-else="">Subscriptions</t>
            </li>
         </li>
    </template>

    
   
    <!-- Add Menu -->
    <template id="portal_my_home_sale_subscription_orer" name="Show Subscription Orders" customize_show="True" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
            <t t-set="portal_alert_category_enable" t-value="True"/>
        </xpath>

        <div id="portal_client_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/de_subscription/static/description/portal_icon.svg'"/>
                <t t-set="title">Subscriptions</t>
                <t t-set="url" t-value="'/my/suborders'"/>
                <t t-set="text">Manage Your Subscriptions</t>
                <t t-set="placeholder_count" t-value="'subscription_order_count'"/>
            </t>
        </div>
    </template>

    <!-- List of orders -->
    <template id="portal_my_subscription_orders" name="My Subscription Orders">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Your Subscriptions</t>
            </t>
            <div t-if="not subscription_orders" class="alert alert-warning" role="alert">
                There are currently no subscriptions for your account.
            </div>
            <t t-if="subscription_orders" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th class="">Subscription</th>
                        <th class="text-center">Recurring Plan</th>
                        <th class="text-center">Next Invoice Date</th>
                        <th class="text-end">Total</th>
                        <th class="text-center">Type</th>
                        <th class="text-center">Status</th>
                    </tr>
                </thead>
                <t t-foreach="subscription_orders" t-as="subscription">
                    <tr>
                        <td>
<!--
                            <a t-att-href="subscription.get_portal_url()"><t t-out="subscription.name"/></a>
                            -->
                            <a t-attf-href="/my/suborders/#{subscription.id}?access_token=#{subscription.access_token}">
    <span t-field="subscription.name"/>
</a>

                        </td>
                        <td class="text-center"><span t-field="subscription.subscription_plan_id.sudo().name"/></td>
                        <td class="text-center"><span t-field="subscription.date_next_invoice"/></td>
                        <td class="text-end"><span t-out ="subscription.amount_total" t-options="{'widget': 'monetary', 'display_currency': subscription.currency_id}"/></td>
                        <td class="text-center" id="subscription_status">
                            <t t-if="subscription.subscription_status == 'progress' and subscription.date_next_invoice &lt; datetime.date.today()">
                                <span class="badge rounded-pill text-bg-danger"><i class="fa fa-fw fa-repeat"/> To Renew</span>
                            </t>
                            <t t-elif="subscription.subscription_status == 'progress'">
                                <span class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> In Progress</span>
                            </t>
                            <t t-elif="subscription.subscription_status == 'paused'">
                                <span class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> Paused</span>
                            </t>
                            <t t-elif="subscription.subscription_status == 'close'">
                                <span class="badge rounded-pill text-bg-dark"><i class="fa fa-fw fa-remove"/> Closed</span>
                            </t>
                        </td>
                        <td class="text-center"><span t-field="subscription.subscription_type"/></td>
                    </tr>
                </t>
            </t>
            <p t-else="">There are currently no subscriptions for your account.</p>
        </t>
    </template>

    <!-- Subscription Order Page -->
    <template id="sale_subscription_order_portal_template" name="Subscriptions Order" inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <div class="row o_portal_sale_sidebar">
                <t t-call="portal.portal_record_sidebar" id="sale_subscription_order_portal_sidebar">
                    <t t-set="classes" t-value="'d-print-none col-lg-3 col-xl-4'"/>
                    <t t-set="title">
                        <h2 t-field="subscription_order.amount_total" data-id="total_amount"/>
                    </t>
                    <t t-set="entries">
                        <div class="d-flex flex-column gap-4">
                            <div class="d-flex flex-column gap-2" id="sale_order_sidebar_button">
                                <a t-if="subscription_order._has_to_be_signed()" role="button" class="btn btn-primary d-block" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#">
                                    <i class="fa fa-check"/><t t-if="subscription_order._has_to_be_paid()"> Sign &amp; Pay</t><t t-else=""> Accept &amp; Sign</t>
                                </a>
                                <a t-elif="subscription_order._has_to_be_paid()" role="button" id="o_sale_portal_paynow" data-bs-toggle="modal" data-bs-target="#modalaccept" href="#" t-att-class="'d-block %s' % ('btn btn-light' if subscription_order.transaction_ids else 'btn btn-primary')" >
                                    <i class="fa fa-check"/> <t t-if="not subscription_order.signature">Accept &amp; Pay</t><t t-else="">Pay Now</t>
                                </a>
                                <div class="o_download_pdf d-flex gap-1 flex-lg-column flex-xl-row">
                                    <div class="flex-grow-1">
                                        <a class="btn btn-secondary o_print_btn o_portal_invoice_print d-block" t-att-href="subscription_order.get_portal_url(report_type='pdf')" id="print_invoice_report" title="View Details" target="_blank"><i class="fa fa-print"/> View Details</a>
                                    </div>
                                </div>
                            </div>

                            <div class="navspy flex-grow-1 ps-0" t-ignore="true" role="complementary">
                                <ul class="nav flex-column bs-sidenav"></ul>
                            </div>

                            <t t-if="not subscription_order.is_expired and subscription_order.state in ['draft', 'sent']">
                                <div t-if="subscription_order.amount_undiscounted - subscription_order.amount_untaxed &gt; 0.01" class="list-group-item flex-grow-1">
                                    <small><b class="text-muted">Your advantage</b></small>
                                    <small>
                                        <b t-field="subscription_order.amount_undiscounted"
                                            t-options='{"widget": "monetary", "display_currency": ssubscription_order.currency_id}'
                                            style="text-decoration: line-through"
                                            class="d-block mt-1"
                                            data-id="amount_undiscounted" />
                                    </small>
                                    <t t-if="subscription_order.amount_untaxed == subscription_order.amount_total">
                                        <h4 t-field="subscription_order.amount_total" class="text-success" data-id="total_amount"/>
                                    </t>
                                    <t t-else="">
                                        <h4 t-field="subscription_order.amount_untaxed" class="text-success mb-0" data-id="total_untaxed"/>
                                        <small>(<span t-field="subscription_order.amount_total" data-id="total_amount"/> Incl. tax)</small>
                                    </t>
                                </div>
                            </t>

                            <div t-if="subscription_order.user_id">
                                <h6><small class="text-muted">Your contact</small></h6>
                                <div class="o_portal_contact_details d-flex flex-column gap-2">
                                    <div class="d-flex justify-content-start align-items-center gap-2">
                                        <img class="o_avatar o_portal_contact_img rounded" t-att-src="image_data_uri(subscription_order.user_id.avatar_1024)" alt="Contact"/>
                                        <div>
                                            <h6 class="mb-0" t-out="subscription_order.user_id.name"/>
                                            <a href="#discussion" class="d-flex align-items-center gap-2 small fw-bold">
                                            Send message
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </t>
                </t>
                <!-- Page content -->
                    <div id="subscription_content" class="col-12 col-lg-9 col-xl-8 mt-5 mt-lg-0">
                        <!-- main content -->
                        <div t-attf-class="#{'pb-5' if report_type == 'html' else ''}" id="portal_sale_subscription_content">
                            <t t-call="de_subscription.sale_subscription_order_portal_content"/>
                        </div>
                    </div>
                    <!-- end page content -->
            </div>
        </xpath>
    </template>

    <!-- Sale Subscription page main contents -->
    <template id="sale_subscription_order_portal_content" name="Subscription Order Portal Content">
        <div id="introduction" t-attf-class="#{'border-bottom-0 pt-0 pb-3 bg-white' if report_type == 'html' else ''}">
            <div class="row" id="intro_row">
                <table class="table table-borderless table-sm">
                        <tbody style="white-space:nowrap" id="sale_info_table">
                            <tr t-if="subscription_order.subscription_plan_id">
                                <td class="w-100 pb-0 text-wrap">
                                    <h2 class="my-0 col-12 col-lg flex-grow-1 mb-1 mb-lg-0">
                                        Subscription - <em t-out="subscription_order.name"/>
                                    </h2>
                                </td>
                                <td class="w-100 pb-0 text-wrap">
                                    <t t-if="subscription_order.subscription_status == 'progress' and subscription_order.date_next_invoice &lt; datetime.date.today()">
                                        <span class="badge rounded-pill text-bg-danger"><i class="fa fa-fw fa-repeat"/> To Renew</span>
                                    </t>
                                    <t t-elif="subscription_order.subscription_status == 'progress'">
                                        <span class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> In Progress</span>
                                    </t>
                                    <t t-elif="subscription_order.subscription_status == 'paused'">
                                        <span class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> Paused</span>
                                    </t>
                                    <t t-elif="subscription_order.subscription_status == 'close'">
                                        <span class="badge rounded-pill text-bg-dark"><i class="fa fa-fw fa-remove"/> Closed</span>
                                    </t>
                                </td>
                            </tr>
                        </tbody>
                </table>
            </div>
        </div>

        <div id="content">
            <div id="informations" class="row">
                <span id="transaction_info">
                    <div t-if="subscription_order.get_portal_last_transaction() and not invoices and subscription_order.state in ('sent', 'sale') and portal_confirmation == 'pay' and not success and not error"
                        t-att-data-order-id="subscription_order.id">
                        <t t-if="subscription_order.transaction_ids">
                            <t t-call="payment.transaction_status">
                            <t t-set="tx" t-value="subscription_order.get_portal_last_transaction()"/>
                        </t>
                    </t>
                    </div>
                </span>

                <!-- ======  Customer Information  ====== -->
                <div id="customer_info" class="col-12 col-lg-6 mb-4">
                    <h4 class="mb-1">
                        <t t-if="subscription_order.partner_shipping_id == subscription_order.partner_invoice_id">
                            Invoicing and Shipping Address
                        </t>
                        <t t-else="">
                            Invoicing Address
                        </t>
                        <small t-if="subscription_order.partner_id == subscription_order.partner_invoice_id == subscription_order.env.user.partner_id">
                            <a class="small" t-attf-href="/my/account?redirect={{subscription_order.get_portal_url()}}">
                                <i class="fa fa-fw fa-pencil"/>
                            </a>
                        </small>
                    </h4>
                    <hr class="mt-1 mb-2"/>
                </div>

                <!-- ======  Subscription Information  ====== -->
                <div id="subscription_info" class="col-12 col-lg-6 mb-4">
                    <span id="sale_info_title">
                        <h4 class="mb-1">Subscription Information</h4>
                        <hr class="mt-1 mb-2"/>
                    </span>
                    <table class="table table-borderless table-sm">
                        <tbody style="white-space:nowrap" id="sale_info_table">
                            <tr t-if="subscription_order.subscription_plan_id">
                                <th class="ps-0 pb-0">Recurring Plan:</th>
                                <td class="w-100 pb-0 text-wrap"><span t-field="subscription_order.subscription_plan_id.name" /></td>
                            </tr>
                            <tr t-if="subscription_order.date_next_invoice">
                                <th class="ps-0 pb-0">Next Billing Date:</th>
                                <td class="w-100 pb-0 text-wrap"><span t-field="subscription_order.date_next_invoice" t-options='{"widget": "date"}'/></td>
                            </tr>
                            <tr t-if="subscription_order.date_start">
                                <th class="ps-0 pb-0">Start Date:</th>
                                <td class="w-100 pb-0 text-wrap"><span t-field="subscription_order.date_start" t-options='{"widget": "date"}'/></td>
                            </tr>
                            <tr t-if="subscription_order.date_end">
                                <th class="ps-0 pb-0">End Date:</th>
                                <td class="w-100 pb-0 text-wrap"><span t-field="subscription_order.date_end" t-options='{"widget": "date"}'/></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- ======  Last Invoices Details  ====== -->
                <t t-set="invoices" t-value="subscription_order.invoice_ids.filtered(lambda i: i.state not in ['draft', 'cancel']).sorted('date', reverse=True)[:3]"/>
                <div id="sale_invoices" t-if="invoices and subscription_order.state in ['sale', 'cancel']" class="col-12 col-lg-6 mb-4">
                    <h4 class="mb-1">Last Invoices</h4>
                    <hr class="mt-1 mb-2"/>
                    <t t-foreach="invoices" t-as="i">
                        <t t-set="report_url" t-value="i.get_portal_url()"/>
                        <t t-set="authorized_tx_ids" t-value="i.authorized_transaction_ids"/>
                        <div class="d-flex flex-column">
                            <div class="d-flex align-items-center justify-content-between">
                                <a t-att-href="report_url">
                                    <span t-out="i.name"/>
                                </a>
                                <div t-if="i.payment_state in ('paid', 'in_payment')" class="small badge text-bg-success orders_label_text_align">
                                    <i class="fa fa-fw fa-check"/> Paid
                                </div>
                                <div t-elif="authorized_tx_ids" class="small badge text-bg-success orders_label_text_align">
                                    <i class="fa fa-fw fa-check"/> Authorized
                                </div>
                                <div t-else="" class="small badge text-bg-info orders_label_text_align">
                                    <i class="fa fa-fw fa-clock-o"/> Waiting Payment
                                </div>
                            </div>
                            <div class="small d-lg-inline-block">Date: <span class="text-muted" t-field="i.invoice_date"/></div>
                        </div>
                    </t>
                </div>


                <!-- ====== Line Items Details  ====== -->
                <t t-set="display_discount" t-value="True in [line.discount > 0 for line in subscription_order.order_line]"/>

                <div class="table-responsive">
                    <table t-att-data-order-id="subscription_order.id" t-att-data-token="subscription_order.access_token" class="table table-sm" id="sales_order_table">
                        <thead class="bg-100">
                            <tr>
                                <th class="text-start" id="product_name_header">Products</th>
                                <th class="text-end" id="product_qty_header">Quantity</th>
                                <th t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                    Unit Price
                                </th>
                                <th t-if="display_discount" t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                    <span>Disc.%</span>
                                </th>
                                <th t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" id="taxes_header">
                                    <span>Taxes</span>
                                </th>
                                <th class="text-end" id="subtotal_header">
                                    <span>Amount</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="sale_tbody">

                            <t t-set="current_subtotal" t-value="0"/>
                            <t t-set="lines_to_report" t-value="subscription_order._get_order_lines_to_report()"/>

                            <t t-foreach="lines_to_report" t-as="line">

                                <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>

                                <tr t-att-class="'bg-200 fw-bold o_line_section' if line.display_type == 'line_section' else 'fst-italic o_line_note' if line.display_type == 'line_note' else ''">
                                    <t t-if="not line.display_type">
                                        <td id="product_name">
                                            <span t-field="line.name"/>
                                        </td>
                                        <td class="text-end" id="quote_qty_td">
                                            <div id="quote_qty">
                                                <span t-field="line.product_uom_qty"/>
                                                <span t-field="line.product_uom"/>
                                            </div>
                                        </td>
                                        <td t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                            <div
                                                t-if="line.discount &gt;= 0"
                                                t-field="line.price_unit"
                                                t-att-style="line.discount and 'text-decoration: line-through' or None"
                                                t-att-class="(line.discount and 'text-danger' or '') + ' text-end'"
                                            />
                                            <div t-if="line.discount">
                                                <t t-out="(1-line.discount / 100.0) * line.price_unit" t-options='{"widget": "float", "decimal_precision": "Product Price"}'/>
                                            </div>
                                        </td>
                                        <td t-if="display_discount" t-attf-class="text-end {{ 'd-none d-sm-table-cell' if report_type == 'html' else '' }}">
                                            <strong t-if="line.discount &gt; 0" class="text-info">
                                                <t t-out="((line.discount % 1) and '%s' or '%d') % line.discount"/>%
                                            </strong>
                                        </td>
                                        <td t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}" id="taxes">
                                            <span t-out="', '.join(map(lambda x: (x.description or x.name), line.tax_id))"/>
                                        </td>
                                        <td t-if="not line.is_downpayment" class="text-end" id="subtotal">
                                        <span class="oe_order_line_price_subtotal" t-field="line.price_subtotal"/>
                                        </td>
                                    </t>
                                    <t t-if="line.display_type == 'line_section'">
                                        <td colspan="99">
                                            <span t-field="line.name"/>
                                        </td>
                                        <t t-set="current_section" t-value="line"/>
                                        <t t-set="current_subtotal" t-value="0"/>
                                    </t>
                                    <t t-if="line.display_type == 'line_note'">
                                        <td colspan="99">
                                            <span t-field="line.name"/>
                                        </td>
                                    </t>
                                </tr>
                                <tr t-if="current_section and (line_last or lines_to_report[line_index+1].display_type == 'line_section') and not line.is_downpayment"
                                    class="is-subtotal text-end">
                                    <td colspan="99">
                                        <strong class="mr16">Subtotal</strong>
                                        <span t-out="current_subtotal"
                                            t-options='{"widget": "monetary", "display_currency": subscription_order.currency_id}'
                                        />
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>

                
            </div>
        </div>
    </template>


    <!-- Sale order (quotations): display recurrence -->
    <template id="sale_order_portal_template_inherit_subscription" inherit_id="sale.sale_order_portal_template">
        This is new template
    </template>

    <template id="sale_order_portal_content_inherit" inherit_id="sale.sale_order_portal_content">
        <xpath expr="//div[@id='sale_info']/span[@id='sale_info_title']" position="attributes">
            <attribute name="t-if">not sale_order.subscription_order</attribute>
        </xpath>
        <xpath expr="//div[@id='sale_info']/table[1]" position="attributes">
            <attribute name="t-if">not sale_order.subscription_order</attribute>
        </xpath>
        <xpath expr="//div[@id='intro_row']" position="inside">
            <div class="col-12 col-lg flex-grow-0 text-lg-end mb-1 mb-lg-0" t-if="sale_order.subscription_order">
                <span t-if="sale_order.subscription_status in ['progress', 'paused'] and sale_order.date_next_invoice &lt; datetime.date.today()" class="badge rounded-pill text-bg-danger"><i class="fa fa-fw fa-repeat"/> To Renew</span>
                <span t-elif="sale_order.subscription_status == 'progress'" class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> In Progress</span>
                <span t-elif="sale_order.subscription_status == 'paused'" class="badge rounded-pill text-bg-success"><i class="fa fa-fw fa-check"/> Paused</span>
                <span t-if="sale_order.subscription_status in ['close']" class="badge rounded-pill text-bg-dark"><i class="fa fa-fw fa-remove"/> Closed</span>
            </div>
        </xpath>
        <xpath expr="//div[@id='sale_info']" position="inside">
            <span id="subscription_info_title" t-if="sale_order.subscription_order">
                <h4 class="mb-1">Subscription Information</h4>
                <hr class="mt-1 mb-2"/>
            </span>
            <table class="table table-borderless table-sm" t-if="sale_order.subscription_order">
                <tbody style="white-space:nowrap" id="sale_info_table">
                    <tr t-if="sale_order.subscription_plan_id">
                        <th class="ps-0 pb-0">Recurring Plan:</th>
                        <td class="w-100 pb-0 text-wrap"><span t-field="sale_order.subscription_plan_id.name" /></td>
                    </tr>
                    <tr t-if="sale_order.date_next_invoice">
                        <th class="ps-0 pb-0">Next Billing Date:</th>
                        <td class="w-100 pb-0 text-wrap"><span t-field="sale_order.date_next_invoice" t-options='{"widget": "date"}'/></td>
                    </tr>
                    <tr t-if="sale_order.date_start">
                        <th class="ps-0 pb-0">Start Date:</th>
                        <td class="w-100 pb-0 text-wrap"><span t-field="sale_order.date_start" t-options='{"widget": "date"}'/></td>
                    </tr>
                    <tr t-if="sale_order.date_end">
                        <th class="ps-0 pb-0">End Date:</th>
                        <td class="w-100 pb-0 text-wrap"><span t-field="sale_order.date_end" t-options='{"widget": "date"}'/></td>
                    </tr>
                </tbody>
            </table>
        </xpath>
    </template>
</odoo>