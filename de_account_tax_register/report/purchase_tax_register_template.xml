<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_header_custom" inherit_id="web.internal_layout">
            <xpath expr="//div[@class='header']" position="replace">
                <div class ="header">                
                    <div style="margin-right:10px;padding:10px;left:10px;display:table-cell;">
                     <t t-esc="invoices.company_id.name"/> <br/>
                     <strong>STRN:</strong> <t t-esc="invoices.company_id.partner_id.vat"/>  <br/>
                     <strong>NTN:</strong> <t t-esc="invoices.company_id.partner_id.ntn"/>
                   </div>
                </div>
            </xpath>
   </template>

<template id="purchase_tax_register">
    <t t-call="web.html_container">
    <t t-call="web.internal_layout">
        <t t-set="docs" t-value="docs.with_context()"/>
        <div class="page">
            <t t-set="qtysumtot" t-value="0"/>
            <t t-set="exvsumtot" t-value="0"/>
            <t t-set="totsumtot" t-value="0"/>
            <div class="oe_structure"/>
            <table class="table table-sm table-striped table-bordered">

                <tr style="height:30%">
                    <th  align="center">From Date</th>
                    <th  align="center"><span t-field="docs.start_date"/></th>
                    <th  align="center">To Date</th>
                    <th  align="center"> <span t-field="docs.end_date"/></th>
                </tr>

            </table>
            <div align="center"> 
                <br/>
                <h2> Purchase Register</h2>
            </div>
            <br/>
        
            <br/>
            <table class="table table-sm table-striped table-bordered">
		
                <thead>
                    <tr>
                        <th>DATE</th>
                        <th>SUPPLIER NAME</th>
                        <th>INVOICE NO</th>
                        <th>ITEM NAME</th>
                        <th>QUANTITY</th>
                        <th>VALUE EXC S.TAX </th>
                       
                            <t t-set="taxes" t-value="[]"/>
                                <t t-foreach="invoices.invoice_line_ids.tax_ids" t-as="t">
                                    <t t-set="taxes" t-value="taxes+[t]"/>
                            </t>  
                        
                        <t t-foreach="set(taxes)" t-as="t">
                            <t t-if="taxes">
                              <th><span t-field="t.description"/></th>
                            </t>
                        </t>
                        
                        <th  >VALUE INC S.TAX</th>
                    </tr>
                </thead>
                      <t t-foreach="invoices.sorted(key=lambda x: x.name)" t-as="invoice">
                       <t t-if="invoice.invoice_line_ids.tax_ids">
                       <t t-if=" not 'IMPORT' in invoice.invoice_line_ids.partner_id.name">     
                        <t t-set="qtysum" t-value="0"/>
                        <t t-set="exvsum" t-value="0"/>
                        <t t-set='invno' t-value="0"/>   
                        <t t-set="taxsum" t-value="0"/>
                        <t t-set="totsum" t-value="0"/>
                        <t t-set="lineitem" t-value="0"/>      
                <tbody class="sale_tbody">
                        <t t-foreach="invoice.invoice_line_ids" t-as="line">
                          <t t-if='line.tax_ids'>       
                          <t t-set="lineitem" t-value="lineitem + 1"/>         
                        <tr>
                            <td ><span t-field="line.date"/></td>
                            <td >
                                <span t-field="line.move_id.partner_id"/><br/>
                                <span t-field="line.move_id.partner_id.street"/>
                                <span t-field="line.move_id.partner_id.street2"/>
                                <span t-field="line.move_id.partner_id.city"/>
                                <span t-field="line.move_id.partner_id.country_id"/><br/>
                                <span t-field="line.move_id.partner_id.ntn"/><br/>
                                <span t-field="line.move_id.partner_id.nic"/><br/>                               
                            </td>
                           <t t-set='invno' t-value="line.move_id.name.split('/')"/>
                            <td ><span t-esc="invno[2]"/></td>
                            <td ><span t-field="line.product_id"/></td>
                            <td ><span t-field="line.quantity"/></td>
                            <t t-set="qtysum" t-value="qtysum + line.quantity"/>
                            <t t-set="qtysumtot" t-value="qtysumtot + line.quantity"/>
                            <td><span t-field="line.debit"/></td>
                            <t t-set="exvsum" t-value="exvsum + line.debit"/>
                            <t t-set="exvsumtot" t-value="exvsumtot + line.debit"/>
                            
                            <t t-if="lineitem >= 2">
                                <t t-set="taxsum" t-value="0"/>     
                            </t>
                            
                            <t t-foreach="set(taxes)" t-as="t">
                                <td>
                                <t t-foreach="line.tax_ids" t-as="tax">                               
                                    <t t-if="t.id==tax.id">
                                        <span t-esc="round(((int(tax.amount) / 100) * line.debit),2)"/>
                                       <t t-if="tax.amount != '' ">
                                        <t t-set="taxsum" t-value="taxsum + round(((int(tax.amount) / 100) * line.debit),2)"/>
                                       </t>    
                                    </t>
                                   
                                </t>
                                </td>
                            </t>
                            <td><span t-esc="round((line.price_subtotal + taxsum),2)"/></td>
                            <t t-set="totsum" t-value="totsum + round((line.price_subtotal + taxsum),2)"/>
                            <t t-set="totsumtot" t-value="totsumtot + round((line.price_subtotal + taxsum),2)"/>
                           </tr>
                            </t>
                            </t>
                       <t t-if="lineitem >= 2">   
                      <tr>
                         <td colspan="4">Sub Total</td>
                         <td><span t-esc="qtysum"></span></td> 
<!--                          <t t-set="qtysumtot" t-value="qtysumtot + qtysum"/> -->
                         <td><span t-esc="round(exvsum,2)"></span></td>
<!--                          <t t-set="exvsumtot" t-value="exvsumtot + exvsum"/> -->
                        <t t-foreach="set(taxes)" t-as="t">
                             <td>
                            </td>
                       </t>
                         <td>
                             <span t-esc="round(totsum,2)"></span>
<!--                              <t t-set="totsumtot" t-value="totsumtot + invoice.amount_total"/> -->
                        </td>              
                    </tr>
                    </t>        
                </tbody>
                    </t>        
                   </t>         
                 </t>
            </table>
            <br/>
            <br/> 

<!--             Grand total at end of register -->
        <table class="table table-sm table-striped table-bordered">
                 <tr>
                        <th width="15%"></th>
                        <th width="15%"></th>
                        <th width="15%"></th>
                        <th width="15%"></th>
                        <th>QUANTITY</th>
                        <th>VALUE EXC S.TAX </th>
                        <th>SALE TAX</th>
                        <th  >VALUE INC S.TAX</th>
                    </tr>

                <tr>
                    <td colspan="4">Total</td>
                         <td><span t-esc="round(qtysumtot,2)"></span></td>
                         <td><span t-esc="round(exvsumtot,2)"></span></td>
                             <td>
                               <span t-esc="round((totsumtot-exvsumtot),2)"></span>
                            </td>
                         <td>
                             <span t-esc="round(totsumtot,2)"></span>
                         </td>
                </tr>
            </table>
          </div>
    </t>
    </t>
</template>
</odoo>
