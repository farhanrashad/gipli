<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form view -->
    <record id="project_helpdesk_ticket_form_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.form.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <form string="Project Ticket">
                <field name="allowed_reopen" invisible="1" />
                 <field name="is_ticket" invisible="1" />
                <header>
                    <button string="Reopen Ticket" name="action_reopen_ticket" type="object"
                        invisible="not allowed_reopen or not is_ticket" />
                    <field name="stage_id" widget="statusbar_duration" options="{'clickable': '1', 'fold_field': 'fold'}"/>
                </header>
                <sheet>
                    <field name="project_id" invisible="1"/>
                     <field name="company_id" invisible="1"/>
                    <field name="active" invisible="1"/>
                    <field name="is_sla" invisible="1"/>
                    <field name="domain_user_ids" invisible="1"/>
                    
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                    <field name="state" widget="state_selection"/>

                    <div class="oe_button_box" name="button_box">
                        <button invisible="count_reopen == 0"
                            name="open_reopen_ticket_reaons"
                            class="oe_stat_button"
                            icon="fa-file-text-o"
                            type="object">
                            <field name="count_reopen" widget="statinfo" string="Reopen Reasons"/>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <label for="ticket_no" string="Ticket Ref"/>
                        <span><field name="ticket_no" readonly="1"/></span>
                        <label for="name" string="Subject"/>
                        <h1>
                            <field name="name" options="{'line_breaks': False}" widget="text" class="field_name" placeholder="e.g. Product arrived damaged"/>
                        </h1>
                    </div>
                    <div class="d-flex mb-4" >
                        <div invisible="not sla_date_deadline or not is_sla"  class="mx-2 text-muted d-inline-flex align-items-center h-100">
                            <i class="fa fa-lg fa-clock-o me-2 mt-1" aria-label="Sla Deadline" title="Sla Deadline"/>
                            <field name="sla_date_deadline" class="mb-0" widget="remaining_days"/>
                        </div>
                    </div>
                    <group>
                        <group>
                            <field name="project_id" 
                                required="1" 
                                string="Helpdesk Team" 
                                domain="[('is_helpdesk_team','=',True)]"
                                context="{
                                'kanban_view_ref': 'helpdesk.helpdesk_team_view_kanban_mobile', 
                                'default_is_sla': True, 
                                'default_is_helpdesk_team': True
                                }"
                            />
                            <field name="user_ids" domain="['&amp;', ('id', 'in', domain_user_ids), ('share', '=', False)]" widget="many2many_avatar_user"/>
                            
                            <field name="ticket_priority" widget="priority"/>
                            <field name="prj_ticket_type_id" options="{'no_open': True}"/>
                            <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color', 'no_create_edit': True}"/>
                        </group>
                        <group>
                            <field name="partner_id" class="field_partner_id" domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]" widget="res_partner_many2one" context="{'default_phone': partner_phone}"/>
                            <field name="is_update_partner_phone" invisible="1"/>
                            <label for="partner_phone" string="Phone"/>
                            <div class="o_row o_row_readonly">
                                <field name="partner_phone" widget="phone" string="Phone"/>
                                <span class="fa fa-exclamation-triangle text-warning oe_edit_only"
                                title="By saving this change, the customer phone number will also be updated." invisible="not is_update_partner_phone"/>
                            </div>
                            <field name="email_cc" groups="base.group_no_one"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="description" string="Description">
                            <field name="description" type="html" options="{'collaborative': true, 'resizable': false}" placeholder="Add details about issue..."/>
                        </page>
                        <page string="Extra Info" name="extra_info">
                            <group>
                                <field name="company_id" groups="base.group_multi_company" context="{'create': False}"/>
                            </group>
                        </page>
                        <page string="SLA" name="ticket_sla">
                            <field name="prj_task_sla_line">
                                <tree editable="bottom" >
                                    <field name="prj_sla_id" />
                                    <field name="date_deadline" />
                                </tree>
                            </field>
                        </page>
                        <page string="Customer Feedback" name="customer_feedback" invisible="not allow_customer_rating">
                            <field name="allow_customer_rating" invisible="1" />
                            <group>
                                <group>
                                    <field name="rating" readonly="1"/>
                                </group>
                                <group>
                                    <field name="closed_by" readonly="1"/>
                                </group>
                                <field name="rating_comment" readonly="1" />
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids" options="{'post_refresh': 'recipients'}"/>
                </div>
            </form>
        </field>
    </record>
    <!-- Tree view -->
    <record id="project_helpdesk_tickets_tree_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.tree.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <tree string="Tickets" multi_edit="1" sample="1" default_order="ticket_priority desc, sla_date_deadline, id">
                <field name="company_id" column_invisible="True"/>
                <field name="project_id" column_invisible="True"/>
                <field name="is_sla" column_invisible="True"/>
                <field name="ticket_no" />
                <field name="ticket_priority" optional="show" widget="priority"/>
                 <field name="name" string="Name"/>
                <field name="user_ids" optional="show" widget="many2many_avatar_user"/>
                <field name="partner_id" domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]" optional="show" options="{'no_open': True}"/>
                <field name="company_id" groups="base.group_multi_company" optional="show" readonly="1" column_invisible="context.get('default_project_id', False)"/>
                <field name="activity_ids" widget="list_activity" optional="show"/>
                <field name="sla_date_deadline" invisible="not is_sla" optional="show" widget="remaining_days"/>
                <field name="create_date" optional="hide" readonly="1" string="Creation Date"/>
                <field name="write_date" optional="hide" readonly="1"/>
                <field name="stage_id" optional="show" readonly="not context.get('default_project_id', False)"/>
            </tree>
        </field>
    </record>
    <!-- Search view -->
    <record id="project_helpdesk_ticket_search_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.search.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <search string="Tickets Search">
                <field name="name"/>
                <field name="ticket_priority" invisible="1"/>
                <field name="project_id"/>
                <field name="user_ids"/>

                <filter string="My Tickets" domain="[('user_ids','in',uid)]" name="my_ticket"/>
                <filter string="Unassigned Tickets" domain="[('user_ids','=',False)]" name="unassigned"/>
                <separator/>
                <filter string="Open Tickets" domain="[('stage_id.fold', '=', False)]" name="is_open"/>
                <filter string="Closed Tickets" domain="[('stage_id.fold', '=', True)]" name="is_close"/>
                <separator/>
                <filter name="filter_create_date" date="create_date"/>
                <filter name="filter_sla_date_deadline" date="sla_date_deadline"/>
                <separator/>
                <separator/>
                <filter string="Archived" domain="[('active','=',False)]" name="archive"/>
                <group expand="0" string="Group By">
                  <filter string="Assignee" name="assignee" context="{'group_by':'user_ids'}"/>
                  <filter string="Helpdesk Team" name="team" context="{'group_by':'project_id'}"/>
                  <filter string="Creation Date" context="{'group_by':'create_date:week'}" name="group_by_create_date"/>
                </group>
            </search>
        </field>
    </record>
    
    <record id="action_project_helpdesk_my_task" model="ir.actions.act_window">
        <field name="name">Tickets</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,form</field>
         <field name="search_view_id" ref="project_helpdesk_ticket_search_view"/>
        <field name="domain">[
            ('project_id.is_helpdesk_team', '=', True),
        ]
        </field>
        <field name="context">{
            'default_is_ticket': 1,
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new ticket!
            </p><p>
                Creating a new ticket typically refers to initiating a request or reporting an issue within a ticketing system or customer support platform. This process involves providing relevant details such as the nature of the request or problem, any pertinent information, and contact details for follow-up communication. It serves as a means to track, prioritize, and resolve inquiries or concerns efficiently.
            </p>
        </field>
    </record>
      
    <menuitem name="My Tickets" id="menu_helpdesk_tickets_my_tickets"
            parent="menu_helpdesk_tickets" 
            action="action_project_helpdesk_my_task"
            sequence="10"
        />

    <record id="project_helpdesk_my_tickets_tree_view" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_helpdesk_tickets_tree_view"/>
        <field name="act_window_id" ref="action_project_helpdesk_my_task"/>
    </record>

    <record id="project_helpdesk_my_ticket_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_helpdesk_ticket_form_view"/>
        <field name="act_window_id" ref="action_project_helpdesk_my_task"/>
    </record>
    
    <!-- All Tickets -->
    <record id="action_project_helpdesk_all_task" model="ir.actions.act_window">
        <field name="name">Tickets</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="project_helpdesk_ticket_search_view"/>
        <field name="domain">[
            ('project_id.is_helpdesk_team', '=', True),
            ]
        </field>
        <field name="context">{
            'default_is_ticket': 1,
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new ticket!
            </p><p>
                Creating a new ticket typically refers to initiating a request or reporting an issue within a ticketing system or customer support platform. This process involves providing relevant details such as the nature of the request or problem, any pertinent information, and contact details for follow-up communication. It serves as a means to track, prioritize, and resolve inquiries or concerns efficiently.
            </p>
        </field>
    </record>
      
    <menuitem name="All Tickets" id="menu_helpdesk_tickets_all_tickets"
            parent="menu_helpdesk_tickets" 
            action="action_project_helpdesk_all_task"
            sequence="10"
        />

    <record id="project_helpdesk_all_tickets_tree_view" model="ir.actions.act_window.view">
        <field name="sequence" eval="2"/>
        <field name="view_mode">tree</field>
        <field name="view_id" ref="project_helpdesk_tickets_tree_view"/>
        <field name="act_window_id" ref="action_project_helpdesk_all_task"/>
    </record>

    <record id="project_helpdesk_all_ticket_form" model="ir.actions.act_window.view">
        <field name="sequence" eval="3"/>
        <field name="view_mode">form</field>
        <field name="view_id" ref="project_helpdesk_ticket_form_view"/>
        <field name="act_window_id" ref="action_project_helpdesk_all_task"/>
    </record>
</odoo>