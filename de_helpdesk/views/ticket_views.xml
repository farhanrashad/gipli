<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Form view -->
    <record id="project_helpdesk_ticket_form_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.form.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <form string="Project Ticket">
                <field name="allowed_reopen" invisible="1" />
                 <field name="is_ticket" invisible="1" />
                <header>
                    <button string="Reopen Ticket" name="action_reopen_tickets" type="object"
                        invisible="not allowed_reopen or not is_ticket" 
                        groups="de_helpdesk.group_project_ticket_reopen"
                    />
                    <field name="stage_id" widget="statusbar_duration" options="{'clickable': '1', 'fold_field': 'fold'}"/>
                </header>
                <sheet>
                    <field name="project_id" invisible="1"/>
                     <field name="company_id" invisible="1"/>
                    <field name="active" invisible="1"/>
                    <field name="is_sla" invisible="1"/>
                    <field name="domain_user_ids" invisible="1"/>
                    
                    <widget name="web_ribbon" title="Archived" bg_color="text-bg-danger" invisible="active"/>
                    <field name="state" widget="state_selection"/>

                    <div class="oe_button_box" name="button_box">
                        <button invisible="count_reopen == 0"
                            name="open_reopen_ticket_reaons"
                            class="oe_stat_button"
                            icon="fa-file-text-o"
                            type="object">
                            <field name="count_reopen" widget="statinfo" string="Reopen Reasons"/>
                        </button>
                    </div>
                    
                    <div class="oe_title">
                        <label for="ticket_no" string="Ticket Ref"/>
                        <span><field name="ticket_no" readonly="1"/></span>
                        <label for="name" string="Subject"/>
                        <h1>
                            <field name="name" options="{'line_breaks': False}" widget="text" class="field_name" placeholder="e.g. Product arrived damaged"/>
                        </h1>
                    </div>
                    <div class="d-flex mb-4" >
                        <div invisible="not sla_date_deadline or not is_sla"  class="mx-2 text-muted d-inline-flex align-items-center h-100">
                            <i class="fa fa-lg fa-clock-o me-2 mt-1" aria-label="Sla Deadline" title="Sla Deadline"/>
                            <field name="sla_date_deadline" class="mb-0" widget="remaining_days"/>
                        </div>
                    </div>
                    <group>
                        <group>
                            <field name="project_id" 
                                required="1" 
                                string="Helpdesk Team" 
                                domain="[('is_helpdesk_team','=',True)]"
                                context="{
                                'kanban_view_ref': 'helpdesk.helpdesk_team_view_kanban_mobile', 
                                'default_is_sla': True, 
                                'default_is_helpdesk_team': True
                                }"
                            />
                            <field name="user_ids" domain="['&amp;', ('id', 'in', domain_user_ids), ('share', '=', False)]" widget="many2many_avatar_user"/>
                            
                            <field name="ticket_priority" widget="priority"/>
                            <field name="prj_ticket_type_id" options="{'no_open': True}"/>
                            <field name="tag_ids" widget="many2many_tags" options="{'color_field': 'color', 'no_create_edit': True}"/>
                        </group>
                        <group>
                            <field name="partner_id" class="field_partner_id" domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]" widget="res_partner_many2one" context="{'default_phone': partner_phone}"/>
                            <field name="is_update_partner_phone" invisible="1"/>
                            <label for="partner_phone" string="Phone"/>
                            <div class="o_row o_row_readonly">
                                <field name="partner_phone" widget="phone" string="Phone"/>
                                <span class="fa fa-exclamation-triangle text-warning oe_edit_only"
                                title="By saving this change, the customer phone number will also be updated." invisible="not is_update_partner_phone"/>
                            </div>
                            <field name="email_cc" groups="base.group_no_one"/>
                        </group>
                    </group>
                    <notebook>
                        <page name="description" string="Description">
                            <field name="description" type="html" options="{'collaborative': true, 'resizable': false}" placeholder="Add details about issue..."/>
                        </page>
                        <page string="Extra Info" name="extra_info">
                            <group>
                                <group>
                                    <field name="sla_date_deadline" />
                                    <field name="sla_hours_deadline" />
                                    <field name="is_sla_fail" />
                                     <field name="is_sla_success" />
                                    
                                </group>
                                <group>
                                    <field name="closed_by" />
                                    <field name="hours_close" />
                                    <field name="date_closed" />
                                    <field name="company_id" groups="base.group_multi_company" context="{'create': False}"/>
                                </group>
                            </group>
                        </page>
                        <page string="SLA" name="ticket_sla">
                            <field name="ticket_sla_ids">
                                <tree editable="bottom" >
                                    <field name="prj_sla_id" />
                                    <field name="date_deadline" />
                                    <field name="date_reached" />
                                    <field name="sla_stage_id" />
                                    <field name="sla_time" widget="float_time" />
                                    <field name="status" />
                                </tree>
                            </field>
                        </page>
                        <page string="Customer Feedback" name="customer_feedback" invisible="not allow_customer_rating">
                            <field name="allow_customer_rating" invisible="1" />
                            <group>
                                <group>
                                    <field name="customer_rating" readonly="0"/>
                                </group>
                                <group>
                                    <field name="closed_by" readonly="1"/>
                                </group>
                                <field name="rating_comment" readonly="1" />
                            </group>
                        </page>
                    </notebook>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids" options="{'post_refresh': 'recipients'}"/>
                </div>
            </form>
        </field>
    </record>
    <!-- Tree view -->
    <record id="project_helpdesk_tickets_tree_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.tree.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <tree string="Tickets" multi_edit="1" sample="1" default_order="ticket_priority desc, sla_date_deadline, id">
                <field name="company_id" column_invisible="True"/>
                
                <field name="is_sla" column_invisible="True"/>
                <field name="ticket_no" />
                <field name="ticket_priority" optional="show" widget="priority"/>
                 <field name="name" string="Name"/>
                <field name="project_id" string="Helpdesk Team" />
                <field name="user_ids" optional="show" widget="many2many_avatar_user"/>
                <field name="partner_id" domain="['|', ('company_id', '=', False), ('company_id', '=', company_id)]" optional="show" options="{'no_open': True}"/>
                <field name="company_id" groups="base.group_multi_company" optional="show" readonly="1" column_invisible="context.get('default_project_id', False)"/>
                <field name="activity_ids" widget="list_activity" optional="show"/>
                <field name="sla_date_deadline" invisible="not is_sla" optional="show" widget="remaining_days"/>
                <field name="create_date" optional="hide" readonly="1" string="Creation Date"/>
                <field name="write_date" optional="hide" readonly="1"/>
                <field name="state" nolabel="1" optional="show" widget="state_selection"/>
                <field name="stage_id" widget="badge" optional="show" readonly="not context.get('default_project_id', False)"/>
            </tree>
        </field>
    </record>
    <!-- Search view -->
    <record id="project_helpdesk_ticket_search_view" model="ir.ui.view">
        <field name="name">project.helpdesk.ticket.search.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <search string="Tickets Search">
                <field name="name" string="Ticket" filter_domain="['|', ('name', 'ilike', self), ('ticket_ref', 'ilike', self)]"/>
                <field name="ticket_no" />
                <field name="tag_ids"/>
                <field name="partner_id" filter_domain="['|', '|', '|', ('partner_id', 'ilike', self), ('partner_email', 'ilike', self), ('partner_phone', 'ilike', self), ('partner_name', 'ilike', self)]"/>

                <field name="project_id" string="Team" invisible="context.get('default_project_id', False)"/>
                <field name="prj_ticket_type_id"/>
                <field name="stage_id"/>
                <field name="ticket_sla_ids" groups="de_helpdesk.group_project_sla_enabled"/>
                <field name="company_id" groups="base.group_multi_company" invisible="context.get('default_project_id', False)"/>
                <field name="description"/>
                
                <field name="ticket_priority" invisible="1"/>

                <filter string="My Tickets" domain="[('user_ids','in',uid)]" name="my_ticket"/>
                <filter string="Followed" domain="[('message_is_follower', '=', True)]" name="my_followed_ticket"/>
                <filter string="Unassigned" domain="[('user_ids','=',False)]" name="unassigned_ticket"/>
                <separator/>
                <filter string="Urgent" domain="[('ticket_priority', '=', 3)]" name="priority_urgent"/>
                <filter string="High Priority" domain="[('ticket_priority', '=', 2)]" name="priority_high"/>
                <filter string="Medium Priority" domain="[('ticket_priority', '=', 1)]" name="priority_medium"/>
                <filter string="Low Priority" domain="[('ticket_priority', '=', 0)]" name="priority_low"/>

                <!-- SLA Filters -->
                <separator groups="de_helpdesk.group_project_sla_enabled"/>
                <filter string="SLA Success" domain="[('ticket_sla_ids.status', '=', 'reached')]" name="sla_success" groups="de_helpdesk.group_project_sla_enabled"/>
                <filter string="SLA in Progress" domain="[('ticket_sla_ids.status', '=', 'ongoing')]" name="sla_inprogress" groups="de_helpdesk.group_project_sla_enabled"/>
                <filter string="SLA Failed" domain="[('ticket_sla_ids.status', '=', 'failed')]" name="sla_failed" groups="de_helpdesk.group_project_sla_enabled"/>
                                
                <separator/>
                <filter string="Open" domain="[('stage_id.fold', '=', False)]" name="open_tickets"/>
                <filter string="Closed" domain="[('stage_id.fold', '=', True)]" name="close_tickets"/>
                <filter string="Closed in Last 7 days" name="closed_last_7days" domain="[('date_closed','&gt;', (context_today() - datetime.timedelta(days=7)).strftime('%%Y-%%m-%%d'))]"/>
                <filter string="Closed in Last 30 days" name="closed_last_30days" domain="[('date_closed', '&gt;', (context_today() - datetime.timedelta(days=30)).strftime('%%Y-%%m-%%d'))]"/>

                <separator groups="de_helpdesk.group_project_ticket_customer_ratings"/>
                <filter name="customer_rating_excellent" string="Excellent" domain="[('customer_rating', '=', '5')]" groups="de_helpdesk.group_project_ticket_customer_ratings"/>
                <filter name="customer_rating_good" string="Good" domain="[('customer_rating', '=', '4')]" groups="de_helpdesk.group_project_ticket_customer_ratings"/>
                <filter name="customer_rating_average" string="Average" domain="[('customer_rating', '=', '3')]" groups="de_helpdesk.group_project_ticket_customer_ratings"/>
                <filter name="customer_rating_fair" string="Fair" domain="[('customer_rating', '=', '2')]" groups="de_helpdesk.group_project_ticket_customer_ratings"/>
                <filter name="customer_rating_poor" string="Poor" domain="[('customer_rating', '=', '1')]" groups="de_helpdesk.group_project_ticket_customer_ratings"/>


                
                <separator/>
                <filter name="filter_create_date" date="create_date"/>
                <filter name="filter_sla_date_deadline" date="sla_date_deadline"/>
                <separator/>
                <separator/>
                <filter string="Archived" domain="[('active','=',False)]" name="archive"/>
                <group expand="0" string="Group By">
                    <filter string="Assignee" name="group_assignee" context="{'group_by':'user_ids'}"/>
                    <filter string="Helpdesk Team" name="group_team" context="{'group_by':'project_id'}"/>
                    <filter string="Stage" name="group_stage" context="{'group_by':'stage_id'}"/>
                    <filter string="Status" name="group_kanban_state" context="{'group_by': 'state'}"/>
                    <filter string="Type" name="group_ticket_type" context="{'group_by':'prj_ticket_type_id'}"/>
                    <filter string="Tags" name="group_tag" context="{'group_by': 'tag_ids'}"/>
                    <filter string="Priority" name="group_priority" context="{'group_by': 'ticket_priority'}"/>
                    <filter string="Customer" name="group_customer" context="{'group_by': 'partner_id'}"/>
                    <filter string="Company" name="group_company" context="{'group_by': 'company_id'}" groups="base.group_multi_company"/>
                    <filter string="SLA" name="group_tickets_sla" context="{'group_by': 'ticket_sla_ids'}" groups="de_helpdesk.group_project_sla_enabled"/>
                    <filter string="SLA Deadline" name="group_sla_deadline" context="{'group_by': 'sla_date_deadline'}" groups="helpdesk.group_project_sla_enabled"/>
                    <filter string="Create Date" name="group_created_by" context="{'group_by': 'create_date'}"/>

                </group>
            </search>
        </field>
    </record>

    <!-- Graph view -->
    <record id="project_ticket_graph_view" model="ir.ui.view">
        <field name="name">project.ticket.graph.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <graph string="Helpdesk Tickets" type="bar" sample="1" >
                <field name="stage_id"/>
                <field name="color" invisible="1"/>
            </graph>
        </field>
    </record>

    <!-- Pivot view -->
    <record id="project_ticket_pivot_view" model="ir.ui.view">
        <field name="name">project.ticket.pivot.view</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <pivot string="Helpdesk Tickets" sample="1" >
                <field name="stage_id" type="col"/>
                <field name="color" invisible="1"/>
            </pivot>
        </field>
    </record>

    <!-- cohort view -->
    <record id="project_ticket_view_cohort" model="ir.ui.view">
        <field name="name">project.ticket.view.cohort</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <cohort string="Tickets" date_start="create_date" date_stop="date_closed" interval="day" sample="1">
                <field name="customer_rating" string="Rating (/5)"/>
            </cohort>
        </field>
    </record>
    
    <!-- Kanban view inherit -->
    <record id="project_ticket_kanban_view_inherit" model="ir.ui.view">
        <field name="name">project.ticket.kanban.view.inherit</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_kanban"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='priority']" position="after">
                <field name="ticket_priority" />
                <field name="is_ticket" />
                <field name="ticket_no" />
                <field name="prj_ticket_type_id" />
            </xpath>
            <xpath expr="//div[hasclass('o_kanban_record_headings')]/strong" position="inside">
                (<field name="ticket_no" 
                    invisible="not is_ticket"
                />)
            </xpath>
            <xpath expr="//div[hasclass('o_kanban_record_body')]" position="inside">
                <field name="prj_ticket_type_id" 
                    invisible="not is_ticket"
                />
            </xpath>
            <xpath expr="//div[hasclass('oe_kanban_bottom_left')]//field[@name='priority']" position="attributes">
                <attribute name="invisible">is_ticket</attribute>
            </xpath>
            <xpath expr="//div[hasclass('oe_kanban_bottom_left')]//field[@name='priority']" position="after">
                <field name="ticket_priority" 
                    widget="priority" 
                    style="margin-right: 5px;"
                    invisible="not is_ticket"
                />
            </xpath>
      </field>
    </record>
    
    <record id="action_project_ticket" model="ir.actions.act_window">
        <field name="name">Tickets</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,kanban,activity,pivot,graph,cohort,form</field>
         <field name="search_view_id" ref="project_helpdesk_ticket_search_view"/>
        <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('project_helpdesk_tickets_tree_view')}),
                (0, 0, {'view_mode': 'kanban', 'view_id': ref('project.view_task_kanban')}),
                (0, 0, {'view_mode': 'pivot', 'view_id': ref('project_ticket_pivot_view')}),
                (0, 0, {'view_mode': 'graph', 'view_id': ref('project_ticket_graph_view')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('project_helpdesk_ticket_form_view')}),
            
            ]"/>
        <field name="domain">[
            ('project_id.is_helpdesk_team', '=', True),
        ]
        </field>
        <field name="context">{
            'default_is_ticket': 1,
            'search_default_my_ticket': 1,
            'search_default_open_tickets':1,
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new ticket!
            </p><p>
                Creating a new ticket typically refers to initiating a request or reporting an issue within a ticketing system or customer support platform. This process involves providing relevant details such as the nature of the request or problem, any pertinent information, and contact details for follow-up communication. It serves as a means to track, prioritize, and resolve inquiries or concerns efficiently.
            </p>
        </field>
    </record>
      
    <menuitem name="My Tickets" id="menu_helpdesk_tickets_my_tickets"
            parent="menu_helpdesk_tickets" 
            action="action_project_ticket"
            sequence="10"
        />

    <!-- All Tickets -->
    <record id="action_project_helpdesk_all_ticket" model="ir.actions.act_window">
        <field name="name">Tickets</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,kanban,activity,pivot,graph,cohort,form</field>
        <field name="search_view_id" ref="project_helpdesk_ticket_search_view"/>
        <field name="view_ids" eval="[(5, 0, 0),
                (0, 0, {'view_mode': 'tree', 'view_id': ref('project_helpdesk_tickets_tree_view')}),
                (0, 0, {'view_mode': 'kanban', 'view_id': ref('project.view_task_kanban')}),
                (0, 0, {'view_mode': 'pivot', 'view_id': ref('project_ticket_pivot_view')}),
                (0, 0, {'view_mode': 'graph', 'view_id': ref('project_ticket_graph_view')}),
                (0, 0, {'view_mode': 'form', 'view_id': ref('project_helpdesk_ticket_form_view')}),
            
            ]"/>
        <field name="domain">[
            ('project_id.is_helpdesk_team', '=', True),
            ]
        </field>
        <field name="context">{
            'default_is_ticket': 1,
            'search_default_open_tickets':1,
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new ticket!
            </p><p>
                Creating a new ticket typically refers to initiating a request or reporting an issue within a ticketing system or customer support platform. This process involves providing relevant details such as the nature of the request or problem, any pertinent information, and contact details for follow-up communication. It serves as a means to track, prioritize, and resolve inquiries or concerns efficiently.
            </p>
        </field>
    </record>
      
    <menuitem name="All Tickets" id="menu_helpdesk_tickets_all_tickets"
            parent="menu_helpdesk_tickets" 
            action="action_project_helpdesk_all_ticket"
            sequence="10"
        />

    
</odoo>