<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add Breadcrumb -->
    <!-- Modify portal templates -->
    <template id="portal_my_home_menu_project_helpdesk" name="Portal layout : Helpdesk menu entry" inherit_id="portal.portal_breadcrumbs" priority="50">
         <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
             <li t-if="page_name == 'project_ticket' or ticket and ticket.is_ticket" t-attf-class="breadcrumb-item #{'active ' if not sale_order else ''}">
                <a t-if="task_ticket" t-attf-href="/my/desk/tickets?{{ keep_query() }}">Tickets</a>
                <t t-else="">Tickets</t>
            </li>
         </xpath>
    </template>

    
   
    <!-- Add Menu -->
    <template id="portal_my_home_task_ticket" name="Show Helpdesk" customize_show="True" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
            <t t-set="portal_alert_category_enable" t-value="True"/>
        </xpath>

        <div id="portal_client_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/de_helpdesk/static/description/portal_icon.svg'"/>
                <t t-set="title">Tickets</t>
                <t t-set="url" t-value="'/my/desk/tickets'"/>
                <t t-set="text">Manage Your Tickets</t>
                <t t-set="placeholder_count" t-value="'tickets_count'"/>
            </t>
        </div>
    </template>

    <!-- List of orders -->
    <template id="portal_my_tickets" name="My Tickets">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>

            <t t-call="portal.portal_searchbar">
                <t t-set="title">Your Tickets</t>
            </t>
            <div t-if="not tickets" class="alert alert-warning" role="alert">
                There are currently no tickets for your account.
            </div>
            <t t-if="tickets" t-call="portal.portal_table">
                <thead>
                    <tr class="active">
                        <th class="">Ticket</th>
                        <th class="">Reported On</th>
                        <th class="">Agent</th>
                        <th class="">Status</th>
                    </tr>
                </thead>
                <t t-foreach="tickets" t-as="ticket">
                    <tr>
                        <td>
                            <a t-attf-href="/my/desk/ticket/#{ticket.id}?access_token=#{ticket.access_token}">
                                <span t-field="ticket.name"/>
                            </a>
                        </td>
                        <td class="">
                            <span t-field="ticket.create_date"/>
                        </td>
                        <td class="">
                           <t t-set="assignees" t-value="ticket.sudo().user_ids"/>
                                    <div t-if="assignees" class="row flex-nowrap ps-3">
                                        <img class="rounded-circle o_portal_contact_img me-2 px-0" t-attf-src="#{image_data_uri(assignees[:1].avatar_128)}" alt="User" style="width: 20px; height: 20px;"/>
                                        <span t-out="'%s%s' % (assignees[:1].name, ' + %s others' % len(assignees[1:]) if len(assignees.user_ids) > 1 else '')" t-att-title="'\n'.join(assignees.mapped('name'))"/>
                                    </div>
                        </td>
                        <td class="" id="ticket_status">
                            <span t-field="ticket.stage_id.name"/>
                        </td>
                    </tr>
                </t>
            </t>
            <p t-else="">There are currently no tickets for your account.</p>
        </t>
    </template>

    <!-- Individual Ticket Page -->
    <template id="portal_my_ticket" name="My Ticket" inherit_id="portal.portal_sidebar" primary="True">
        <t t-call="portal.portal_layout">
            <t t-set="title" t-value="ticket.name"/>
            <t t-set="wrapwrap_classes" t-value="'o_portal_bg_dark'"/>

            <t t-set="o_portal_fullwidth_alert" groups="helpdesk.group_helpdesk_user">
                <t t-call="portal.portal_back_in_edit_mode">
                    <t t-set="backend_url" t-value="'/web#model=project.task&amp;id=%s&amp;view_type=form' % (ticket.id)"/>
                </t>
            </t>

            <div class="row mt16 o_project_portal_sidebar">
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-3 col-xl-4 d-print-none'"/>
                </t>
                <!-- Main Contents -->
                <div id="ticket_content" class="o_portal_content col-12 col-lg-9 col-xl-8 mt-5 mt-lg-0">
                    <div t-if="ticket_closed" class="alert alert-success alert-dismissible d-print-none" role="status">
                        <span>Your ticket has successfully been closed. Thank you for your collaboration.</span>
                    </div>
                    <div id="card">
                        <div id="card_header" class="container" data-anchor="true">
                            <div class="row gs-0">
                                <div class="col-md">
                                    <h5 class="row justify-content-between">
                                        <div class="col-md-9 text-truncate">
                                            <span t-field="ticket.name" class="h3"/>
                                            <small class="text-muted"> (#<span t-field="ticket.name"/>)</small>
                                        </div>
                                        <div class="col col-auto">
                                            <small class="text-end">Stage:</small>
                                            <span t-field="ticket.stage_id.name" t-attf-class="badge rounded-pill #{'text-bg-info' if ticket.stage_id.fold else 'text-bg-light bg-200'}" title="Current stage of this ticket"/>
                                        </div>
                                    </h5>
                                </div>
                            </div>
                        </div>
                        <div id="card_body">
                            <div class="row mb-4">
                                <strong class="col-lg-3">Reported on</strong>
                                <span class="col-lg-9" t-field="ticket.create_date" t-options='{"widget": "datetime", "hide_seconds": True}'/>
                            </div>
                            
                            <div t-if="not is_html_empty(ticket.description)" class="row mt-3" name="description">
                                <div class="col-lg-12" t-field="ticket.description"/>
                            </div>
                        </div>
                    </div>

                    <hr/>
                    <div class="o_portal_messages_container" id="ticket_chat" data-anchor="true">
                        <h3>Communication history</h3>
                        <t t-call="portal.message_thread">
                            <t t-set="token" t-value="ticket.access_token"/>
                            <t t-set="disable_composer" t-value="ticket.stage_id.fold"/>
                        </t>
                    </div>

                    
                </div>
            </div>
        </t>
    </template>
</odoo>