<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Add Breadcrumb -->
    <!-- Modify portal templates -->
    
    <template id="portal_my_home_menu_project_helpdesk" name="Portal layout : Helpdesk menu entry" inherit_id="portal.portal_breadcrumbs" priority="50">
        
        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="attributes">
            <attribute name="t-if">not ticket</attribute>
        </xpath>

        <xpath expr="//ol[hasclass('o_portal_submenu')]" position="after">
            <ol t-if="detail_page=='ticket'" class="o_portal_submenu breadcrumb mb-0 flex-grow-1 px-0"> 
                <li class="breadcrumb-item ms-1"><a href="/my/home" aria-label="Home" title="Home" previewlistener="true"><i class="fa fa-home"></i></a></li>

                <li class="breadcrumb-item ms-1">
                    <a t-if="ticket" t-attf-href="/my/desk/tickets?{{ keep_query() }}">Tickets</a>
                </li>
                <li t-if="ticket" class="breadcrumb-item ms-1">
                    <span t-esc="ticket.name" />
                </li>
                
            </ol>
        </xpath>
        
         <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
             <!--
                 <li class="breadcrumb-item ms-1"><a href="/my/home" aria-label="Home" title="Home" previewlistener="true"><i class="fa fa-home"></i></a></li>
             -->
                 <li t-if="page_name == 'ticket' or ticket" t-attf-class="breadcrumb-item #{'active ' if not ticket else ''}">
                    <a t-if="ticket" t-attf-href="/my/desk/tickets?{{ keep_query() }}">Tickets</a>
                    <t t-else="">Tickets</t>
                </li>

             <!--
                 <li t-if="ticket" class="breadcrumb-item active text-truncate">
                    <span t-field="ticket.name"/> (#<span t-field="ticket.name"/>)
                </li>
             -->
         </xpath>
    </template>

    
   
    <!-- Add Menu -->
    <template id="portal_my_home_task_ticket" name="Show Helpdesk" customize_show="True" inherit_id="portal.portal_my_home" priority="40">
        <xpath expr="//div[hasclass('o_portal_docs')]" position="before">
            <t t-set="portal_client_category_enable" t-value="True"/>
            <t t-set="portal_alert_category_enable" t-value="True"/>
        </xpath>

        <div id="portal_client_category" position="inside">
            <t t-call="portal.portal_docs_entry">
                <t t-set="icon" t-value="'/de_helpdesk/static/description/portal_icon.svg'"/>
                <t t-set="title">Tickets</t>
                <t t-set="url" t-value="'/my/desk/tickets'"/>
                <t t-set="text">Manage Your Tickets</t>
                <t t-set="placeholder_count" t-value="'tickets_count'"/>
            </t>
        </div>
    </template>

    <!-- List of orders -->
    <template id="portal_my_tickets" name="My Tickets">
        <t t-call="portal.portal_layout">
            <t t-set="breadcrumbs_searchbar" t-value="True"/>
            <t t-call="portal.portal_searchbar">
                <t t-set="title">Tickets</t>
            </t>
            <div t-if="not grouped_tickets" class="alert alert-warning" role="alert">
                There are currently no tickets for your account.
            </div>
            <t t-else="">
                <t t-call="portal.portal_table">
                    <thead>
                        <tr class="active">
                            <th class="">Ticket</th>
                            <th class="">Reported On</th>
                            <th class="">Agent</th>
                            <th class="">Status</th>
                        </tr>
                    </thead>
                    <t t-foreach="grouped_tickets" t-as="tickets">
                        <tbody>
                            <tr t-if="not groupby =='none'" class="table-light">
                                <th t-if="groupby == 'stage'" colspan="5">
                                    <span t-field="tickets[0].stage_id.name"/>
                                </th>
                                
                                <th t-if="groupby == 'create_date'" colspan="5">
                                    <span t-field="tickets[0].create_date"/>
                                </th>
                            </tr>
                
                            <t t-foreach="tickets" t-as="ticket">
                                <tr>
                                    <td class="text-start"><a t-attf-href="/my/desk/ticket/#{ticket.id}"><small>#<span t-att-title="ticket.ticket_no" t-field="ticket.ticket_no"/></small><span class="ms-2" t-att-title="ticket.name" t-field="ticket.name"/></a></td>
                                    <td class="">
                                        <span t-field="ticket.create_date"/>
                                    </td>
                                    <td class="">
                                        <t t-set="assignees" t-value="ticket.sudo().user_ids"/>
                                        <div t-if="assignees" class="row flex-nowrap ps-3">
                                            <img class="rounded-circle o_portal_contact_img me-2 px-0" t-attf-src="#{image_data_uri(assignees[:1].avatar_128)}" alt="User" style="width: 20px; height: 20px;"/>
                                            <span t-out="'%s%s' % (assignees[:1].name, ' + %s others' % len(assignees[1:]) if len(assignees.user_ids) > 1 else '')" t-att-title="'\n'.join(assignees.mapped('name'))"/>
                                        </div>
                                    </td>
                                    <td class="" id="ticket_status">
                                        <span t-attf-class="badge #{'text-bg-success' if ticket.stage_id.fold else 'text-bg-primary'} fw-normal o_text_overflow" t-attf-title="#{ticket.stage_id.name}" t-esc="ticket.stage_id.name"/>
                                    </td>
                                </tr>
                            </t>
                        </tbody>
                    </t>
                </t>
            </t>
        </t>
    </template>

    <!-- Popup window models -->
    <template id="customer_feedback_template" name="Customer Feedback">
        <input class="d-none" name="csrf_token" t-att-value="request.csrf_token()"/>
            <main class="modal-body">
                <t t-if="not ticket.allow_customer_rating">
                    <div class="row mb-0">
                        <h3 class="text-center">Closing Ticket Reason</h3>
                        <p>
                                        Kindly provide the specific reason for closing this ticket.
                        </p>
                    </div>
                    <div class="row mt-0">
                        <span class="col-lg-1"/>
                        <span class="col-lg-10">
                            <textarea name="comment" 
                                rows="10" 
                                cols="30" 
                                placeholder="Write the detail reason for closure"
                                style="width:100%;"
                            />                                        
                        </span>
                        <span class="col-lg-1"/>
                    </div>
                </t>
                <t t-if="ticket.allow_customer_rating"> 
                    <div class="row mb-0">
                        <h3 class="text-center">Rate Your Experince</h3>
                        <p>
                                        Your feedback is essential to us. Please take a moment to rate your experience with our helpdesk services and share any insights or suggestions you may have.
                        </p>
                    </div>
                    <div class="row mb-0">
                        <span class="col-lg-1"/>
                        <span class="col-lg-2">
                            <input type="radio" id="rating_poor" name="rating" value="1"/>
                            <label for="rating_poor">Poor</label>
                        </span>
                        <span class="col-lg-2">
                            <input type="radio" id="rating_fair" name="rating" value="2"/>
                            <label for="rating_fair">Fair</label>
                        </span>
                        <span class="col-lg-2">
                            <input type="radio" id="rating_average" name="rating" value="3"/>
                            <label for="rating_average">Average</label>
                        </span>
                        <span class="col-lg-2">
                            <input type="radio" id="rating_good" name="rating" value="4"/>
                            <label for="rating_good">Good</label>
                        </span>
                        <span class="col-lg-2">
                            <input type="radio" id="rating_excellent" name="rating" value="5"/>
                            <label for="rating_excellent">Excellent</label>
                        </span>
                        <span class="col-lg-1"/>
                    </div>
                    <div class="row mb-4">
                        <span class="col-lg-1"/>
                        <span class="col-lg-2">
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                        </span>
                        <span class="col-lg-2">
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                        </span>
                        <span class="col-lg-2">
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                        </span>
                        <span class="col-lg-2">
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#e5e5e5;"/>
                        </span>
                        <span class="col-lg-2">
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                            <span class="fa fa-star" style="color:#ffcc33;"/>
                        </span>
                        <span class="col-lg-1"/>
                    </div>
                    <div class="row mt-0">
                        <span class="col-lg-1"/>
                        <span class="col-lg-10">
                            <textarea name="comment" 
                                rows="10" 
                                cols="30" 
                                placeholder="Tell us about your experience!"
                                style="width:100%;"
                            />                                        
                        </span>
                        <span class="col-lg-1"/>
                    </div>
                </t>
            </main>
    </template>
    
    <template id="model_ticket_close_template">
        <div role="dialog" class="modal fade" id="modal-ticket-close" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <header class="modal-header">
                        <h4 class="modal-title">
                            <span t-field="ticket.name" class="text-primary"/>
                        </h4>
                    </header>
                    <form method="post" t-attf-action="/my/desk/ticket/close/#{ticket.id}?access_token=#{ticket.access_token}">
                        <t t-call="de_helpdesk.customer_feedback_template"/>
                        <footer class="modal-footer">
                                <button class="btn btn-primary">Close Ticket</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            </footer>
                    </form>
                </div>
            </div>
        </div>
    </template>



    <template id="model_ticket_open_template">
        <div role="dialog" class="modal fade" id="modal-ticket-open" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <header class="modal-header">
                            <h4 class="modal-title">
                                <span t-field="ticket.name" class="text-primary"/>
                            </h4>
                        </header>
                        <form method="post" t-attf-action="/my/desk/ticket/reopen/#{ticket.id}?access_token=#{ticket.access_token}">
                            <input class="d-none" name="csrf_token" t-att-value="request.csrf_token()"/>
                            <main class="modal-body">
                                <h3 class="text-center">Reopen Your Ticket</h3>
                        <p>
                                        Please provide the reason for reopening the ticket in the form below. Our team will review your request and take appropriate action to assist you further. Thank you for reaching out 
                        </p>
                                
                                <textarea name="reason" 
                                    rows="10" 
                                    cols="30" 
                                    placeholder="Write the detail reason for opening the ticket"
                                    style="width:100%;"
                                    required="1"
                                />   
                            </main>
                            <footer class="modal-footer">
                                <button class="btn btn-primary">Open Ticket</button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                            </footer>
                        </form>
                    </div>
                </div>
            </div>
    </template>
    
    <!-- Individual Ticket Page -->
    <template id="portal_my_ticket" name="My Ticket" inherit_id="portal.portal_sidebar" primary="True">
        <xpath expr="//div[hasclass('o_portal_sidebar')]" position="inside">
            <t t-call="de_helpdesk.model_ticket_close_template" />
            <t t-call="de_helpdesk.model_ticket_open_template" />
            <div class="row o_project_portal_sidebar">
                <t t-call="portal.portal_record_sidebar">
                    <t t-set="classes" t-value="'col-lg-3 col-xl-4 d-print-none'"/>
                    <t t-set="entries">
                        <div class="d-flex flex-column gap-4">
                            <div class="d-flex flex-column gap-2" id="ticket_close_sidebar_button">
                                <a role="button" t-if="ticket.allow_portal_user_close_ticket" class="btn btn-primary d-block" data-bs-toggle="modal" data-bs-target="#modal-ticket-close" href="#">
                                    <i class="fa fa-check"/> Close Ticket
                                </a>
                                <a role="button" t-if="ticket.allow_portal_user_reopen_ticket" class="btn btn-primary d-block" data-bs-toggle="modal" data-bs-target="#modal-ticket-open" href="#">
                                    <i class="fa fa-check"/> Re-Open Ticket
                                </a>
                            </div>
                            
                            <div t-if="ticket.partner_id" class="mt-1">
                                <div t-attf-class="col-12 col-md-12" t-if="ticket.partner_id">
                                    <h6>
                                        <small class="text-muted">Customer</small>
                                    </h6>
                                </div>
                                <div class="o_portal_contact_details d-flex flex-column gap-1">
                                    <div class="d-flex justify-content-start align-items-center gap-2">
                                        <img class="o_avatar o_portal_contact_img rounded" t-att-src="image_data_uri(ticket.partner_id.avatar_128)" alt="Contact"/>
                                        <h6 class="mb-0" t-out="ticket.partner_id.name"></h6>
                                    </div>
                                    <div>
                                        <a t-attf-href="mailto:{{ticket.partner_id.email}}" t-if="ticket.partner_id.email"><div t-field="ticket.partner_id" t-options='{"widget": "contact", "fields": ["email"]}'/></a>
                                        <a t-attf-href="tel:{{ticket.partner_id.phone}}" t-if="ticket.partner_id.phone"><div t-field="ticket.partner_id" t-options='{"widget": "contact", "fields": ["phone"]}'/></a>
                                    </div>
                                </div>
                            </div>
                            <div t-if="ticket.user_ids" class="mt-1">
                                <div t-attf-class="col-12 col-md-12" t-if="ticket.user_ids">
                                    <h6>
                                        <small class="text-muted">Assigned to</small>
                                    </h6>
                                    <t t-set="assignees" t-value="ticket.sudo().user_ids"/>
                                    <div t-if="assignees" class="row flex-nowrap ps-3">
                                        <img class="rounded-circle o_portal_contact_img me-2 px-0" t-attf-src="#{image_data_uri(assignees[:1].avatar_128)}" alt="User" style="width: 20px; height: 20px;"/>
                                        <span t-out="'%s%s' % (assignees[:1].name, ' + %s others' % len(assignees[1:]) if len(assignees.user_ids) > 1 else '')" t-att-title="'\n'.join(assignees.mapped('name'))"/>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-column gap-1" id="sale_order_sidebar_button">
                                <h3>Tickets History</h3>
                                <t t-set="otickets" t-value="request.env['project.task'].sudo().search([('id','!=',ticket.id),('is_ticket','=',True),('partner_id','=',ticket.partner_id.id),('active','=',True)],limit=5,order='create_date desc')"/>
                                <t t-foreach="otickets" t-as="oticket">
                                    <a t-attf-href="/my/desk/ticket/{{oticket.id}}" t-attf-title="{{oticket.name}}" class="d-flex  gap-2 gap-md-3  py-1" previewlistener="true">
                                        <span t-field="oticket.ticket_no"/> - <span t-field="oticket.name"/>
                                    </a>

                                        
                                </t>
                            </div>
                        </div>
                    </t>
                </t>
                <t t-call="de_helpdesk.ticket_portal_main_content_template"/>
                
            </div>
        </xpath>
                
    </template>

    

    <template id="ticket_portal_main_content_template" name="Main Content">
        <!-- Main Contents -->
        <div id="ticket_content" class="o_portal_content col-12 col-lg-9 col-xl-8 mt-5 mt-lg-0">
            <div t-if="ticket.closed_by=='customer'" class="alert alert-success alert-dismissible d-print-none" role="status">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <span>Your support ticket has been successfully resolved and closed. We appreciate your cooperation and assistance throughout the process. Thank you.</span>
            </div>

            <div t-if="op_type=='ticket_reopend'" class="alert alert-warning alert-dismissible d-print-none" role="status">
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                <span>Your ticket has been successfully reopened. Our team will review your request and get back to you as soon as possible. Thank you for reaching out to us.</span>
            </div>
            
            <div id="card">
                <div id="card_header" class="container" data-anchor="true">
                    <div class="row gs-0">
                        <div class="col-md">
                            <span t-esc="breadcrumb"/>
                            <h5 class="row justify-content-between">
                                
                                <div class="col-md-9 text-truncate">
                                    <span t-field="ticket.name" class="h3"/>
                                    <small class="text-muted"> (#<span t-field="ticket.ticket_no"/>)</small>
                                </div>
                                <div class="col col-auto">
                                    <small class="text-end">Stage:</small>
                                    <span t-field="ticket.stage_id.name" t-attf-class="badge rounded-pill #{'text-bg-info' if ticket.stage_id.fold else 'text-bg-light bg-200'}" title="Current stage of this ticket"/>
                                </div>
                            </h5>
                        </div>
                    </div>
                </div>
                <div id="card_body">
                    <div class="row mb-4">
                        <span class="col-lg-2">
                            <strong>Reported on: </strong>
                        </span>
                        <span class="col-lg-4">
                            <span t-field="ticket.create_date" t-options='{"widget": "datetime", "hide_seconds": True}'/>
                        </span>
                        <span class="col-lg-2">
                            <strong>Ticket Type: </strong>
                        </span>
                        <span class="col-lg-4">
                            <span t-field="ticket.prj_ticket_type_id.name" />
                        </span>
                    </div> 

                    <div class="row mb-4">
                        <span class="col-lg-2">
                            <strong>Expected Resolution on: </strong>
                        </span>
                    </div>
                    
                    <div t-if="not is_html_empty(ticket.description)" class="row mt-3" name="description">
                        <div class="col-lg-12" t-field="ticket.description"/>
                    </div>
                </div>
                <hr/>
                <div class="o_portal_messages_container" id="ticket_chat" data-anchor="true">
                    <h3>Communication history</h3>
                    <t t-call="portal.message_thread">
                        <t t-set="token" t-value="ticket.access_token"/>
                        <t t-set="disable_composer" t-value="ticket.stage_id.fold"/>
                    </t>
                </div>
            </div> 
        </div>
    </template>

    <!-- Customer Rating Page Template -->
    <template id="portal_customer_rating_template" name="Customer Rating">
        <t t-call="portal.portal_layout">
            <t t-call="portal.portal_record_layout">
                <t t-set="card_header">
                    <div class="row no-gutters">
                        <div class="col-12 row">
                            <div  class="col-10 col-md-10  text-left">
                                <h5>
                                    <span class="h3"><span t-field="ticket.name" /></span>
                                    <small class="text-muted"><span t-field="ticket.ticket_no" /></small>
                                </h5>
                                <form method="post" t-attf-action="/my/desk/ticket/rating/submit/#{ticket.id}?access_token=#{ticket.access_token}">
                                <t t-call="de_helpdesk.customer_feedback_template"/>
                                <footer class="modal-footer">
                                    <button class="btn btn-primary">Submit Feedback</button>    
                                </footer>
                                </form>
                            </div>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>

    <template id="portal_thanks_message_template" name="Thanks Message">
        <t t-call="portal.portal_layout">
            <t t-call="portal.portal_record_layout">
                <t t-set="card_header">
                    <div class="row no-gutters">
                        <div class="col-12 row">
                            <div  class="col-2" />
                            <div  class="col-8 text-center">
                                 <t t-raw="html_message"/>
                            </div>
                            <div  class="col-2" />
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>