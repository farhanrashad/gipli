<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="batch_wise_payroll">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <div class="page" style="font-size:12px">
                    <div class='pull-left' style='color:blue;'>
                        <h5>Payroll Reconciliation Report</h5>
                        Period <span t-esc="datetime.datetime.strptime(str(from_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>
                        and
                        <span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>
                    </div>
                    <div class='pull-right' style="max-width: 250px;height: 20px; color:blue;">
                        <strong>Printed On:</strong>
                        <span t-esc="datetime.datetime.strptime(str(datetime.datetime.now()+ relativedelta(hours =+ 5)), '%Y-%m-%d %H:%M:%S.%f').strftime('%d-%b-%y %H:%M %p')"/>
                        <br/>
                        <strong>Printed By:</strong><span t-esc="user.name"/>
                        <br/>
                        <strong>Currency:</strong><span t-esc="currency"/>
                        <br/>
                    </div>

                    <table class="table table-sm table-striped table-bordered mt8">
                        <thead>
                            <tr>
                                <th style='color:blue;'>Description</th>
                                <th style='color:blue;'>Amount</th>
                            </tr>
                        </thead>
                        <tbody class="reconcilation_tbody">

                            <tr>
                                <td>
                                    Net salary of <span t-esc="len(from_batch_id.slip_ids)"/> employees for  <span t-esc="datetime.datetime.strptime(str(from_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>
                                </td>
                                <td>
                                    <span t-esc="'{0:,}'.format(int(round(sum(from_batch_id.slip_ids.mapped('net_wage')))))"/>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Net salary of <span t-esc="len(to_batch_id.slip_ids)"/> employees for <span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>

                                </td>
                                <td>
                                    <span t-esc="'{0:,}'.format(int(round(sum(to_batch_id.slip_ids.mapped('net_wage')))))"/>
                                    
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    Net Change: Increase / (Decrease)
                                </td>
                                <td>
                                    <span t-esc="'{0:,}'.format(int(round(sum(to_batch_id.slip_ids.mapped('net_wage'))-sum(from_batch_id.slip_ids.mapped('net_wage')))))"/>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <p style='color:blue;'>Reasons of change in Net Salary Payable</p>
                            <table class="table table-sm table-striped table-bordered">
                                <thead>
                                    <th style='color:blue;'>Compensation</th>
                                    <th style='color:blue;'><span t-esc="datetime.datetime.strptime(str(from_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/></th>
                                    <th style='color:blue;'><span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/></th>
                                    <th style='color:blue;'>Curr-Prv</th>
                                </thead>
                                <tbody class="reconcilation_tbody">
                                    <t t-set="sum_batch1" t-value="0"/>
                                    <t t-set="sum_batch2" t-value="0"/>
                                    <tr t-foreach="rs_rules" t-as="rule">
                                        <td><span t-esc="rule['rule_name']"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(rule['batch1_total'])))"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(rule['batch2_total'])))"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(rule['batch_diff'])))"/></td>
                                        <t t-set="sum_batch1" t-value="sum_batch1 + rule['batch1_total']"/>
                                        <t t-set="sum_batch2" t-value="sum_batch2 + rule['batch2_total']"/>
                                    </tr>
                                    <tr>
                                        <td/>
                                        <td><strong><span t-esc="'{0:,}'.format(int(round(sum_batch1)))"/></strong></td>
                                        <td><strong><span t-esc="'{0:,}'.format(int(round(sum_batch2)))"/></strong></td>
                                        <td style='color:blue;'><strong>Total A: <span t-esc="'{0:,}'.format(int(round(sum_batch2-sum_batch1)))"/></strong></td>
                                    </tr>
                                </tbody>
                            </table>
                    <br/>
                            <table class="table table-sm table-striped table-bordered">
                                <thead>
                                    <th style='color:blue;'>Deductions</th>
                                    <th style='color:blue;'><span t-esc="datetime.datetime.strptime(str(from_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/></th>
                                    <th style='color:blue;'><span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/></th>
                                    <th style='color:blue;'>Curr-Prv</th>
                                </thead>
                                <tbody class="reconcilation_tbody">
                                    <t t-set="sum_ded_batch1" t-value="0"/>
                                    <t t-set="sum_ded_batch2" t-value="0"/>
                                    <tr t-foreach="rs_ded_rules" t-as="ded">
                                        <td><span t-esc="ded['rule_name']"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(ded['batch1_total'])))"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(ded['batch2_total'])))"/></td>
                                        <td><span t-esc="'{0:,}'.format(int(round(ded['batch_diff'])))"/></td>
                                        <t t-set="sum_ded_batch1" t-value="sum_ded_batch1 + ded['batch1_total']"/>
                                        <t t-set="sum_ded_batch2" t-value="sum_ded_batch2 + ded['batch2_total']"/>
                                    </tr>
                                    <tr>
                                        <td/>
                                        <td><strong><span t-esc="'{0:,}'.format(int(round(sum_ded_batch1)))"/></strong></td>
                                        <td><strong><span t-esc="'{0:,}'.format(int(round(sum_ded_batch2)))"/></strong></td>
                                        <td style='color:blue;'><strong>Total B: <span t-esc="'{0:,}'.format(int(round(sum_ded_batch2-sum_ded_batch1)))"/></strong></td>
                                    </tr>
                                    <tr>
                                        <td/>
                                        <td/>
                                        <td/>
                                        <td style='color:blue;'><strong>Total A - Total B: <span t-esc="'{0:,}'.format(int(abs(sum_batch1-sum_batch2)-abs(sum_ded_batch1-sum_ded_batch2)))"/></strong></td>

                                    </tr>
                                </tbody>
                            </table>
                    <br/>
                    <table class="table table-sm table-striped table-bordered">
                        <tbody class="reconcilation_tbody">
                            <tr>
                                <td style='color:blue;'><strong>Total Bank Transferable for <span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>:</strong></td>
                                <td><strong><span t-esc="'{0:,}'.format(int(round(sum(to_batch_id.slip_ids.mapped('net_wage')))))"/></strong></td>
                            </tr>
                        </tbody>
                    </table>
                    <br/><br/><br/><br/><br/><br/><br/>
                    <table class="table table-sm table-striped table-bordered">
                        <tr>
                            <th style="max-width:100px; word-wrap:break-word;padding-left:5px;"></th>

                            <th style="border-top: 1px solid black;padding:5px;text-align:center;">Prepared By</th>
                            <th style="max-width:100px; word-wrap:break-word;padding:5px;"></th>
                            <th style="border-top: 1px solid black;padding:5px;text-align:center;">Verify By</th>
                            <th style="max-width:70px; word-wrap:break-word;padding:5px;"></th>
                            <th style="border-top: 1px solid black;padding:5px;text-align:center;">Approved By</th>
                            <th style="max-width:100px; word-wrap:break-word;padding-left:5px;"></th>
                            <th style="border-top: 1px solid black;padding:5px;text-align:center;">Approved By</th>
                        </tr>
                    </table>
                    
                </div>
                
                <!-- Reconciliation Detail Report -->
                <p style="page-break-before:always;"> </p>
                <div class="page" style="font-size:12px">
                    <div class='pull-left' style='color:blue;'>
                        <h5>Payroll Reconciliation detail</h5>
                        Period <span t-esc="datetime.datetime.strptime(str(from_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>
                        and
                        <span t-esc="datetime.datetime.strptime(str(to_batch_id.date_end),'%Y-%m-%d').strftime('%b-%y')"/>
                    </div>
                    <div class='pull-right' style="max-width: 250px;height: 20px; color:blue;">
                        <strong>Printed On:</strong>
                        <span t-esc="datetime.datetime.strptime(str(datetime.datetime.now()+ relativedelta(hours =+ 5)), '%Y-%m-%d %H:%M:%S.%f').strftime('%d-%b-%y %H:%M %p')"/>
                        <br/>
                        <strong>Printed By:</strong><span t-esc="user.name"/>
                        <br/>
                        <strong>Currency:</strong><span t-esc="currency"/>
                        <br/>
                    </div>
                    
                    <t t-foreach="rs_rules" t-as="rule">
                        <t t-set="sum_rule_batch1" t-value="0"/>
                        <t t-set="sum_rule_batch2" t-value="0"/>
                        <t t-set="sum_batch_diff" t-value="0"/>
                        <table class="table table-sm table-striped table-bordered mt8" style="border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th colspan="2" style='color:blue;'><strong><span t-esc="rule['rule_name']"/></strong></th>
                                </tr>
                                <tr>
                                    <th style='color:blue;'>Sr #</th>
                                    <th style='color:blue;'>Emp.Code</th>
                                    <th style='color:blue;'>Date Of Joining</th>
                                    <th style='color:blue;'>Name</th>
                                    <th style='color:blue;'>Previous</th>
                                    <th style='color:blue;'>Current</th>
                                    <th style='color:blue;'>Difference</th>
                                </tr>
                            </thead>
                            <tbody class="reconcilation_tbody">
                                <t t-foreach="rs_employees" t-as="emp">
                                    <t t-if="rule['rule_id'] == emp['rule_id']">
                                        <tr>
                                            <td><span t-esc="emp['sr_no']"/></td>
                                            <td><span t-esc="emp['emp_number']"/></td>
                                            <td><span t-esc="emp['doj']"/></td>
                                            <td><span t-esc="emp['emp_name']"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch1_total'])))"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch2_total'])))"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch_diff'])))"/></td>
                                        </tr>
                                        <t t-set="sum_rule_batch1" t-value="sum_rule_batch1 + emp['batch1_total']"/>
                                        <t t-set="sum_rule_batch2" t-value="sum_rule_batch2 + emp['batch2_total']"/>
                                        <t t-set="sum_batch_diff" t-value="sum_batch_diff + emp['batch_diff']"/>
                                    </t>
                                </t>
                                <tr>
                                    <td/><td/><td/><td/>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_rule_batch1)))"/></strong></td>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_rule_batch2)))"/></strong></td>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_batch_diff)))"/></strong></td>
                                </tr>
                                <t t-set="sum_rule_batch1" t-value="0"/>
                                <t t-set="sum_rule_batch2" t-value="0"/>
                                <t t-set="sum_batch_diff" t-value="0"/>
                            </tbody>
                        </table>
                        
                    </t>
                    <t t-foreach="rs_ded_rules" t-as="rule">
                        <t t-set="sum_rule_batch1" t-value="0"/>
                        <t t-set="sum_rule_batch2" t-value="0"/>
                        <t t-set="sum_batch_diff" t-value="0"/>
                        <table class="table table-sm table-striped table-bordered mt8" style="border-collapse: collapse;">
                            <thead>
                                <tr>
                                    <th colspan="2" style='color:blue;'><strong><span t-esc="rule['rule_name']"/></strong></th>
                                </tr>
                                <tr>
                                    <th style='color:blue;'>Sr #</th>
                                    <th style='color:blue;'>Emp.Code</th>
                                    <th style='color:blue;'>Date Of Joining</th>
                                    <th style='color:blue;'>Name</th>
                                    <th style='color:blue;'>Previous</th>
                                    <th style='color:blue;'>Current</th>
                                    <th style='color:blue;'>Difference</th>
                                </tr>
                            </thead>
                            <tbody class="reconcilation_tbody">
                                <t t-foreach="rs_employees" t-as="emp">
                                    <t t-if="rule['rule_id'] == emp['rule_id']">
                                        <tr>
                                            <td><span t-esc="emp['sr_no']"/></td>
                                            <td><span t-esc="emp['emp_number']"/></td>
                                            <td><span t-esc="emp['doj']"/></td>
                                            <td><span t-esc="emp['emp_name']"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch1_total'])))"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch2_total'])))"/></td>
                                            <td><span t-esc="'{0:,}'.format(int(round(emp['batch_diff'])))"/></td>
                                        </tr>
                                        <t t-set="sum_rule_batch1" t-value="sum_rule_batch1 + emp['batch1_total']"/>
                                        <t t-set="sum_rule_batch2" t-value="sum_rule_batch2 + emp['batch2_total']"/>
                                        <t t-set="sum_batch_diff" t-value="sum_batch_diff + emp['batch_diff']"/>
                                    </t>
                                </t>
                                <tr>
                                    <td/><td/><td/><td/>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_rule_batch1)))"/></strong></td>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_rule_batch2)))"/></strong></td>
                                    <td><strong><span t-esc="'{0:,}'.format(int(round(sum_batch_diff)))"/></strong></td>
                                </tr>
                            </tbody>
                        </table>
                        
                    </t>
                </div>
            </t>
        </t>
    </template>
</odoo>